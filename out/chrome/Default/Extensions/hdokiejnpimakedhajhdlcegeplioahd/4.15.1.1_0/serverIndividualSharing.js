LPServer.sharing=LPServer.sharing||{},LPServer.sharing.individual=function(){var e,r,a,t,s,n,i=function(){var e,r,a={noemailspecified:function(e,r){r.error(LPServer.ext.translate("Please enter at least one email and try again."))},usernameisnotvalidemail:function(e,r){var a=LPServer.getRecordsFromResponse(e,"email",LPServer.getAttrInt(e,"numinvalid",0));r.error(LPServer.ext.translate("The following emails are invalid: %1",a.join(", ")))},toomanyemails:function(e,r){var a=LPServer.getAttrInt(e,"numexcess");"1"===a?r.error(LPServer.ext.translate("You are trying to share with too many people.  Please remove at least %1 email and try again.",a)):r.error(LPServer.ext.translate("You are trying to share with too many people.  Please remove at least %1 emails and try again.",a))},cantsharewithself:function(e,r){r.error(LPServer.ext.translate("You can not share with yourself."))}},t=function(e,r,a){this.email=e,this.pubkey=r,this.encpass=a},s=function(e,r){this.aid=e.getAttribute("aid"),this.username=LPServer.ext.decrypt(e.getAttribute("username"),r),this.password=LPServer.ext.decrypt(e.getAttribute("password"),r),this.name=LPServer.ext.decrypt(e.getAttribute("name"),r),this.grouping=LPServer.ext.decrypt(e.getAttribute("grouping"),r),this.extra=LPServer.ext.decrypt(e.getAttribute("extra"),r),this.attachkey=LPServer.ext.decrypt(e.getAttribute("attachkey"),r),this.afids=this.parseFields(e.getAttribute("afids"),r),this.otherafids=this.parseFields(e.getAttribute("otherafids"),r),this.accts_notes=this.parseFields(e.getAttribute("accts_notes"),r),this.accts_usernames=this.parseFields(e.getAttribute("accts_usernames"),r),this.accts_passwords=this.parseFields(e.getAttribute("accts_passwords"),r),this.template=e.getAttribute("template")};s.prototype.parseFields=function(e,r){var a=[];if(e)for(var t=0,s=(e=e.split("^")).length;t<s;++t){var n=e[t];""!==n&&(n=e[t].split("&"),a.push({name:n[0],value:LPServer.ext.decrypt(n[1],r)}))}return a},s.prototype.encrypt=(e=function(e,r){return e?LPServer.ext.encryptCBC(e,r):""},r=function(r,a){for(var t=JSON.parse(JSON.stringify(r)),s=0,n=t.length;s<n;++s)t[s].value=e(t[s].value,a);return t},function(a){return{username:e(this.username,a),password:e(this.password,a),name:e(this.name,a),grouping:e(this.grouping,a),extra:e(this.extra,a),attachkey:e(this.attachkey,a),afids:r(this.afids,a),otherafids:r(this.otherafids,a),accts_notes:r(this.accts_notes,a),accts_usernames:r(this.accts_usernames,a),accts_passwords:r(this.accts_passwords,a)}});var n=function(e,r,a,t){for(var s=0,n=a.length;s<n;++s)e[r+t+s+"name"]=a[s].name,e[r+t+s+"value"]=a[s].value;e[r+"num"+t]=a.length},i=function(e,r){var a=LPServer.getAttrInt(e,"numemails",0);1===a?r.success(LPServer.ext.translate("Share sent to %1.",LPServer.getAttr(e,"email0",""))):r.success(LPServer.ext.translate("Share sent to %1 recipients.",a))},c=function(e,r){for(var a=[],t=0,s=e.length;t<s;++t){var n=e[t];n&&a.push({email:n,reason:r})}return a},o=function(e,r){var a=LPServer.getAttrInt(e,"numsharesok",0);if(a>0){for(var o=[],l=0;l<a;++l){var m=LPServer.getAttr(e,"emailok"+l,""),p=LPServer.getAttr(e,"emailokpubkeyhex"+l,""),u=LPServer.getAttr(e,"emailencp"+l,"");o.push(new t(m,p,u))}!function(e,r,a){for(var t={cmd:"share",sharemessage:"",giveshare:a.params.giveshare?1:0,numemails:e.length,numaids:r.length,fromrole:0,sharesyncpush:0,shareautopull:0,reportname:[]},s=0,c=e.length;s<c;++s){var o=e[s],l=LPServer.ext.createRandomHexString(64),m=LPServer.ext.hex2bin(l),p=new LPServer.ext.RSAKey;LPServer.ext.parsePublicKey(p,o.pubkey);var u=p.encrypt(m),h="email"+s;t[h]=o.email,t["sharekeyenchex"+s]=u,t["sharekeyenchexsig"+s]="",o.encpass&&(t["encpass"+s]=o.encpass);for(var v=0;v<r.length;++v){var d=r[v],g=d.encrypt(m);1==a.params.logname&&t.reportname.push({aid:d.aid,name:d.name});var S=h+"aid"+v;t[S]=d.aid,t[S+"username"]=g.username,t[S+"password"]=g.password,t[S+"name"]=g.name,t[S+"grouping"]=g.grouping,t[S+"extra"]=g.extra,t[S+"attachkey"]=g.attachkey,t[S+"template"]=d.template,n(t,S,g.afids,"afid"),n(t,S,g.otherafids,"otherafid"),n(t,S,g.accts_notes,"accts_notes"),n(t,S,g.accts_usernames,"accts_usernames"),n(t,S,g.accts_passwords,"accts_passwords")}}LPServer.xmlRequest({url:"showshare.php",data:t,callbacks:{shareok:i},userSupplied:a})}(o,function(e,r){for(var a=[],t=LPServer.getNodes(e,"encdata"),n=0,i=t.length;n<i;++n)a.push(new s(t[n],r));return a}(e,r.params.key),r)}var h=LPServer.getAttrInt(e,"numsharesdne",0);h>0&&r.callbacks&&r.callbacks.invite&&r.callbacks.invite({emails:LPServer.getRecordsFromResponse(e,"emaildne",h)});var v=LPServer.getAttr(e,"sharingwithself",""),d=LPServer.getAttrInt(e,"numsharesinv",0),g=LPServer.getAttrInt(e,"numsharesuns",0),S=LPServer.getAttrInt(e,"numsharesspa",0),P=LPServer.getAttrInt(e,"numsharesres",0);if((v||d>0||g>0||S>0||P>0)&&r.callbacks&&r.callbacks.problems){var f=c([v],LPServer.ext.translate("You can not share with yourself."));f=(f=(f=(f=f.concat(c(LPServer.getRecordsFromResponse(e,"emailinv",d),LPServer.ext.translate("Invalid email address.")))).concat(c(LPServer.getRecordsFromResponse(e,"emailuns",g),LPServer.ext.translate("The user must login to LastPass at least once to permit sharing.")))).concat(c(LPServer.getRecordsFromResponse(e,"emailspa",S),LPServer.ext.translate("The user does not want to receive emails from LastPass.")))).concat(c(LPServer.getRecordsFromResponse(e,"emailres",P),LPServer.ext.translate("Sharing is restricted by a LastPass Enterprise policy."))),r.callbacks.problems(f)}0===a&&r.error()};return function(e){e.callbacks=LPServer.extend(e.callbacks,a);for(var r={cmd:"getclientdata",shareeusername:e.params.emails,numaids:e.params.aids.length},t=0,s=e.params.aids.length;t<s;++t)r["aid"+t]=e.params.aids[t];LPServer.xmlRequest({url:"showshare.php",data:r,callbacks:{getclientdataack:o},userSupplied:e})}}(),c=(e=function(e,r){r.success(LPServer.ext.translate("Share revoked from %1",r.params.email))},function(r){LPServer.xmlRequest({url:"showshare.php",data:{cmd:"unshare",aid:r.params.id,username:r.params.email},callbacks:{unshareok:e},userSupplied:r})}),o=(r=function(e,r){r.success(LPServer.ext.translate("Share accepted."))},a=function(e,r,a){var t=LPServer.ext.decrypt(e,r);return t?LPServer.ext.encryptCBC(t,a):""},t=function(e){var t=e.params.key,s=e.params.pendingShareKey,n=e.params.pendingShare,i={cmd:"acceptshare",msgtosharer:"",aid:n.id,newgroup:LPServer.ext.encryptCBC(e.params.group,t),name:a(n.sharename,s,t),grouping:a(n.sharegroup,s,t),username:a(n.username,s,t),password:a(n.password,s,t),extra:a(n.extra,s,t),attachkey:a(n.attachkey,s,t)};i.newname=e.params.name?LPServer.ext.encryptCBC(e.params.name,t):i.name;var c=n.save_all?"otherafid":"afid";for(var o in n.shareafids){var l=n.shareafids[o];l&&(l=a(l,s,t)),i[c+o]=l}LPServer.xmlRequest({url:"showacceptshare.php",data:i,callbacks:{acceptshareok:r},userSupplied:e})},function(e){e.params.pendingShare?t(e):e.params.id&&l(LPServer.extend({},e,{params:{id:e.params.id},success:function(r){e.params.pendingShare=r.pendingShare;var a=new LPServer.ext.RSAKey;LPServer.ext.parsePrivateKey(a,LPServer.ext.extractPrivateKey(r.privateKey,e.params.key)),e.params.pendingShareKey=a.decrypt(e.params.pendingShare.sharekeyenchex),t(e)}}))}),l=function(e){var r=e.params&&e.params.id?{aid:e.params.id}:{};e.params.url&&m(e.params.url)&&(r.from="acceptshare",r.confirm_token=p(e.params.url)),LPServer.jsonRequest({url:"getReceivedShareInfo.php",data:r,userSupplied:e})},m=function(e){return!!e.match(/acceptshare=/gi)},p=function(e){var r=e.match(/confirm_token=[^&]*/gi);return r?r[0].split("=")[1]:""};return{shareItems:i,unshareItem:c,acceptShare:o,rejectShare:(s=function(e,r){r.success(LPServer.ext.translate("Share rejected."))},function(e){LPServer.xmlRequest({url:"showacceptshare.php",data:{cmd:"rejectshare",aid:e.params.id},callbacks:{rejectshareok:s},userSupplied:e})}),inviteFriends:(n=function(e,r){if(r.callbacks&&r.callbacks.problems){var a=[],t=LPServer.getAttrInt(e,"numalready",0);if(t>0){var s=LPServer.getRecordsFromResponse(e,"emailalready",t).join(", ");a.push(LPServer.ext.translate("You have already invited the following friends: %1. Please send them a reminder using your personal email as the email invitation sent by LastPass might not have reached them.",s))}var n=LPServer.getAttrInt(e,"numspam",0);if(n>0){var i=LPServer.getRecordsFromResponse(e,"emailspam",n).join(", ");a.push(LPServer.ext.translate("The following friends have marked your invitations as spam: %1.",i))}a.length>0&&r.callbacks.problems(a)}var c=LPServer.getAttrInt(e,"numsent",0);1===c?r.success(LPServer.ext.translate("%1 was invited. We will send you a notification email when they join LastPass so you can retry sharing your data with them.",LPServer.getAttr(e,"emailsent0",""))):c>1?r.success(LPServer.ext.translate("%1 friends were invited. We will send you a notification email when any of them join LastPass so you can retry sharing your data with them.",c)):r.error()},function(e){for(var r={cmd:"invite",numemails:e.params.emails.length},a=0,t=e.params.emails.length;a<t;++a)r["email"+a]=e.params.emails[a];LPServer.xmlRequest({url:"showshare.php",data:r,callbacks:{inviteack:n},userSupplied:e})}),getSentShareData:function(e){LPServer.jsonRequest({url:"getSentShareInfo.php",data:e.params&&e.params.id?{aid:e.params.id}:null,userSupplied:e})},getReceivedShareData:l}}();
//# sourceMappingURL=sourcemaps/serverIndividualSharing.js.map
