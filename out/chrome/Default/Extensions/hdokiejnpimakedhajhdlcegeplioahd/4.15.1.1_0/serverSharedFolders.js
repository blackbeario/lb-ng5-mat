LPServer.sharing=LPServer.sharing||{},LPServer.sharing.folder=function(){var e,r,a,s,n,t,d,i,u,o,l,p,c,m,f,h,S,v,P,g="share.php",L="Shared-",y=function(e,r){r.success(e,{sharedFolder:r.params.sharedFolder,shareInfo:r.params.shareInfo})},x=function(e,r,a){if(r.length>0){e.adminuidcnt=r.length;for(var s=0,n=r.length;s<n;++s){var t=r[s],d=new LPServer.ext.RSAKey;LPServer.ext.parsePublicKey(d,t.key),e["adminsharekey"+s]=d.encrypt(LPServer.ext.bin2hex(a)),e["adminuid"+s]=t.uid}}},b=(r={nouser:function(e,r){r.error&&r.error(""),LPServer.callback(r,"invite",{emails:e.unknownusers.split(",")})},default:e=function(e,r){if(e.success){for(var a={},s=0;void 0!==e["pubkey"+s];)a[e["username"+s]]={uid:e["uid"+s],cgid:e["cgid"+s],pubkey:e["pubkey"+s]},++s;var n=function(e){var r=[];if(e.groupname)for(var a=e.groupname.split(","),s=0,n=a.length;s<n;++s)r.push(a[s]);return r}(e);n.length>0&&LPServer.callback(r,"emptyGroups",n),r.success(a)}else r.error()},emptygroup:e,noshareerr:function(e,r){r.error(LPServer.ext.translate("Sorry, company policy prohibits use of this feature."))}},function(e){LPServer.jsonRequest({url:g,data:{getpubkey:1,uid:"string"==typeof e.params.userInfo?e.params.userInfo:JSON.stringify(e.params.userInfo),jsonr:1},callbacks:r,userSupplied:e})}),k=(a=function(e,r){for(var a in r){var s=r[a];if("group"===s.type&&e.cgid===s.uid)return a}return null},function(e){b(LPServer.extend({},e,{params:{userInfo:e.params.newMembers},success:function(r){!function(e,r){var s,n,t,d={id:r.params.shareInfo.id,update:1,add:1,sharename:r.params.shareInfo.sharename,name:r.params.shareInfo.name,readonly:r.params.readonly?1:0,give:r.params.hidePasswords?0:1,notify:r.params.notify?1:0,canadminister:r.params.can_administer?1:0,xmlr:1},i=r.params.newMembers?r.params.newMembers:{},u=0,o=0,l=[],p={};for(var c in e){var m=e[c];i[c]&&void 0!==i[c]||(i[c]={}),m.readOnly="object"==typeof i&&i[c].readOnly?1:d.readonly,m.canAdminister="object"==typeof i&&i[c].canAdminister?1:d.canadminister,m.give="object"!=typeof i||i[c].hidePasswords||void 0===i[c].hidePasswords?d.give:1,m.pubkey?(d["sharekey"+u]=(s=r.params.shareInfo.key,n=m.pubkey,t=void 0,t=new LPServer.ext.RSAKey,LPServer.ext.parsePublicKey(t,n),t.encrypt(LPServer.ext.bin2hex(s))),d["uid"+u]=m.uid,d["cgid"+u]=m.cgid,d["readonly"+u]=m.readOnly,d["canadminister"+u]=m.canAdminister,d["give"+u]=m.give,++u):(d["msfuser"+o]=m.uid,d["msfcgid"+o]=m.cgid,d["msfreadonly"+o]=m.readOnly,d["msfcanadminister"+o]=m.canAdminister,d["msfgive"+o]=m.give,l.push(c),++o),p[a(m,i)||c]=!0}var f=u+o;f>0?LPServer.xmlRequest({url:g,data:d,callbacks:{useradded:function(e,r){f<=6&&l.length>0&&LPServer.callback(r,"noSharingKeyUsers",l),r.success(LPServer.ext.translate("%1 users/groups were invited.",Object.keys(p).length),p)}},userSupplied:r}):r.error()}(r,e)}}))}),I=(s={ok:function(e,r){var a=LPServer.getAttr(e,"id");r.params.sharedFolder.aid=a,r.params.shareInfo.id=a,r.params.shareInfo.shareid=a,r.params.shareInfo.uid=LPServer.getAttr(e,"uid"),y(LPServer.ext.translate("Shared Folder %1 created.",r.params.sharedFolder.group),r)},exceededlimit:function(e,r){r.error(LPServer.ext.translate("Sorry, as a LastPass Premium user, you are limited to one Shared Folder. Please consider using LastPass Enterprise if you would like more."))},premiumrequired:function(e,r){r.error(LPServer.ext.translate("Sorry, LastPass Premium is required to create a Shared Family Folder"))},alreadyexists:function(e,r){r.error(LPServer.ext.translate("That group already exists."))}},n=function(e,r){var a={};a[r.params.username]={uid:r.params.uid,type:"companyuser"},r.params.superusers=e,b(LPServer.extend({},r,{params:{userInfo:a},success:function(e){!function(e,r){var a=e[r.params.username].pubkey;if(a){var n=r.params.sharedFolder,t=r.params.shareInfo=r.params.shareInfo||{},d={id:0,update:1,newusername:r.params.username+"-"+n.group,name:0===n.group.indexOf(L)?n.group.substring(L.length):n.group,xmlr:1},i=LPServer.ext.makeRandomPassword(),u=t.key=LPServer.ext.makeKey(d.newusername,i,5e3);d.newhash=LPServer.ext.makeHash(u,i,5e3);var o=new LPServer.ext.RSAKey;LPServer.ext.parsePublicKey(o,a),d.sharekey=t.sharekey=o.encrypt(LPServer.ext.bin2hex(u)),d.sharename=t.sharename=LPServer.ext.encryptCBC(n.group,u),x(d,r.params.superusers,u),LPServer.xmlRequest({url:g,data:d,callbacks:s,userSupplied:r})}else LPServer.callback(r,"sharingkeyrequired"),r.error&&r.error("")}(e,r)}}))},function(e){LPServer.jsonRequest({url:"getSuperUserInfo.php",success:n,userSupplied:e})}),R=(t={ok:function(e,r){y(LPServer.ext.translate("Shared Folder %1 was renamed.",r.params.shareInfo.name),r)}},function(e){e.params.shareInfo.name=e.params.sharedFolder.group.substring(L.length),e.params.shareInfo.sharename=LPServer.ext.encryptCBC(e.params.sharedFolder.group,e.params.shareInfo.key),LPServer.xmlRequest({url:g,data:{update:1,rename:1,id:e.params.shareInfo.id,name:e.params.shareInfo.name,sharename:e.params.shareInfo.sharename,xmlr:1},callbacks:t,userSupplied:e})}),w=(d=function(e,r){r.params.shareInfo.deleted="1",y(LPServer.ext.translate("Shared Folder deleted."),r)},function(e){LPServer.xmlRequest({url:g,data:{id:e.params.shareInfo.id,delete:1,xmlr:1},callbacks:{deleted:d},userSupplied:e})}),F=(i=function(e,r){r.success(LPServer.ext.translate("Member removed."))},function(e){var r={id:e.params.shareid,xmlr:1};e.params.msfuser?(r.msfdelete=1,r.msfuser=e.params.uid):(r.update=1,r.delete=1,r.uid=e.params.uid),LPServer.xmlRequest({url:g,data:r,callbacks:{ok:i},userSupplied:e})}),q=(u=function(e,r){r.success(LPServer.ext.translate("Permissions saved."))},function(e){LPServer.xmlRequest({url:"editSharedFolderUsers.php",data:{cmd:"edit",xml:1,shareid:e.params.shareInfo.id,request:JSON.stringify(e.params.updatedPermissions)},callbacks:{ok:u},userSupplied:e})}),j=function(e,r,a){var s={id:r.params.shareInfo.id,xmlr:1};s[e]=1,LPServer.xmlRequest({url:g,data:s,callbacks:a,userSupplied:r})},A=(o=function(e,r){r.params.shareInfo.download="1",y(LPServer.ext.translate("Shared Folder will now be downloaded."),r)},function(e){j("startdownloading",e,{ok:o})}),M=(l=function(e,r){r.params.shareInfo.download="0",y(LPServer.ext.translate("Shared Folder will no longer be downloaded."),r)},function(e){j("stopdownloading",e,{ok:l})}),K=(p={undeleted:function(e,r){r.params.shareInfo.deleted="0",y(LPServer.ext.translate("Shared Folder restored."),r)}},function(e){LPServer.xmlRequest({url:g,data:{id:e.params.shareInfo.id,undelete:1,xmlr:1},callbacks:p,userSupplied:e})}),O=(c={purged:function(e,r){r.success(LPServer.ext.translate("Shared Folder purged."))}},function(e){LPServer.xmlRequest({url:g,data:{id:e.params.shareInfo.id,purge:1,xmlr:1},callbacks:c,userSupplied:e})}),E=(m=function(e,r){r.success(e.folders)},function(e){LPServer.jsonRequest({url:"getSharedFolderInfo.php",success:m,userSupplied:e})}),D=(f={success:function(e,r){r.params.shareInfo.accepted="1",y(LPServer.ext.translate("Shared Folder accepted."),r)}},function(e){LPServer.jsonRequest({url:g,data:{folder:e.params.shareInfo.id,acceptfolder:1,jsonr:1},callbacks:f,userSupplied:e})}),_=(h={success:function(e,r){r.success(LPServer.ext.translate("Shared Folder rejected."))}},function(e){LPServer.jsonRequest({url:g,data:{id:e.params.shareInfo.id,rejectfolder:1,jsonr:1},callbacks:h,userSupplied:e})}),C=(S={success:function(e,r){r.success(LPServer.ext.translate("Shared Folder member reinvited."))}},function(e){var r={reinvite:1,invitee:e.params.uid,folder:e.params.shareid,jsonr:1};"1"===e.params.ent&&(r.ent="on"),LPServer.jsonRequest({url:g,data:r,callbacks:S,userSupplied:e})}),U=(v={success:function(e,r){r.params.shareInfo.cid=LPServer.getAttr(e,"cid"),r.params.shareInfo.outside_enterprise=LPServer.getAttr(e,"outside_enterprise"),y(LPServer.ext.translate("Personal Shared Folder moved into Enterprise. You can now adminster the folder."),r)}},P=function(e,r){var a={id:r.params.shareInfo.id,moveintoenterprise:1,xmlr:1};x(a,e,r.params.shareInfo.key),LPServer.xmlRequest({url:g,data:a,callbacks:v,userSupplied:r})},function(e){LPServer.jsonRequest({url:"getSuperUserInfo.php",success:P,userSupplied:e})});return{SHARED_FOLDER_NAME_PREFIX:L,getFolders:E,getPublicKeys:b,create:I,rename:R,remove:w,accept:D,reject:_,addMembers:k,getMembers:function(e){LPServer.jsonRequest({url:"getSharedFolderMembers.php",data:{shareid:e.params.shareid},userSupplied:e})},removeMember:F,reinviteMember:C,updateMemberPermissions:q,getRestrictions:function(e){LPServer.jsonRequest({url:"getSharedFolderRestrictions.php",data:e.params,userSupplied:e})},updateRestrictions:function(e){LPServer.textRequest({url:g,data:{id:e.params.shareid,edit:1,limit:1,aids:e.params.aids,numaids:e.params.aids.length>0?e.params.aids.split(",").length:0,additionaluids:e.params.additionaluids,hidebydefault:e.params.hidebydefault?1:0,uid:e.params.uid,xmlr:1},success:function(){e.success(LPServer.ext.translate("Access restrictions updated."))},userSupplied:e})},startDownloading:A,stopDownloading:M,restoreDeleted:K,purgeDeleted:O,convertToEnterprise:U}}();
//# sourceMappingURL=sourcemaps/serverSharedFolders.js.map
