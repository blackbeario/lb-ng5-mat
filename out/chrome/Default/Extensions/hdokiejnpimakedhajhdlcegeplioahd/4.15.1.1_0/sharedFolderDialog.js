var SharedFolderDialog=function(e){var r={additionalHeaderClasses:["icon"],closeButtonEnabled:!0,maximizeButtonEnabled:!0,buttonAlign:this.RIGHT_ALIGN};Dialog.call(this,e,r),this.existingUsers=null,this.folder=null};SharedFolderDialog.prototype=Object.create(Dialog.prototype),SharedFolderDialog.prototype.constructor=SharedFolderDialog,function(e){SharedFolderDialog.prototype.initialize=function(e){var r,t,i;Dialog.prototype.initialize.apply(this,arguments),r=this,i=document.getElementById("sharedFolderDialogUserTypeahead"),LPProxy.isEnterpriseUser()?((t=new BloodhoundDropdown(i,{identify:function(e){return"group"===e.type?e.cgid:e.uid},remote:{url:LPProxy.getBaseURL()+"typeahead_remote.php?grp=1&q=%QUERY",wildcard:"%QUERY"}},{optionLabel:function(e){var r=e.name;return"companyuser"===e.type?""===r?r=e.email:""!==e.email&&(r+=" ("+e.email+")"):r+=" ("+Strings.Vault.USER_GROUP+")",r},ignore:function(e,t){return r.existingUsers[e]||void 0===t.type&&!LPFeatures.allowShareOutsideEnterprise()}})).onChange(function(e,t){e=$.extend({},e);var i=SharedFolderUser;"group"===e.type&&(e.uid=e.cgid,delete e.cgid,i=SharedFolderUserGroup),e.username=e.email,delete e.email;var s=new i(e,r.folder);s._pending=!0,r.addNewUser(s),r.existingUsers[t]=!0}),r.inputFields.friends=t):r.inputFields.friends=t=new TypeaheadDropdown(i),LPProxy.isFamilyUser()?$("#sharedFolderDialogDisclaimer").show():$("#sharedFolderDialogDisclaimer").hide(),t.autocomplete=function(e){var t=e.target.value;if(null===this.hint&&t){for(var i=r.parseFriendsInput(t),s=0,a=i.length;s<a;++s)r.addNewUser(i[s]);e.preventDefault()}TypeaheadDropdown.prototype.autocomplete.apply(this,arguments)},Topics.get(Topics.REMOVED_SHARED_FOLDER_USER).subscribe(function(e){delete r.existingUsers[e.getID()],r.showHideInviteInput()}),$("#sharedFolderDialogInviteButton").bind("click",function(){r.submit()})},SharedFolderDialog.prototype.parseFriendsInput=function(e){for(var r=[],t=e.split(","),i=0,s=t.length;i<s;++i){var a,n=t[i].trim();if(n.indexOf("@")>-1){var o=n.match(Constants.EmailAddressRegularExpression);if(o&&1===o.length){var d=o[0];a=new SharedFolderUser({username:d},this.folder)}}else n&&(a=new SharedFolderUserGroup({name:n},this.folder));a&&(a._pending=!0,a.setEditable(!0),r.push(a))}return r},SharedFolderDialog.prototype.validate=function(e){var r=Dialog.prototype.validate.apply(this,arguments);return e.friends&&0===this.parseFriendsInput(e.friends).length&&(this.addError("friends","You must enter a valid email or group name."),r=!1),r},SharedFolderDialog.prototype.defaultFields=function(e){e.defaultData=$.extend({readonly:!0,hidePasswords:!0},e.defaultData),Dialog.prototype.defaultFields.call(this,e)},SharedFolderDialog.prototype.addNewUser=function(e){this.containers.newMembers||(this.containers.newMembers=new Container([],{additionalItemClasses:"dialogItem"}),this.containers.newMembers.initialize(document.getElementById("sharedFolderDialogNewUsersContainer"))),this.containers.newMembers.addChild(e),this.inputFields.friends.clear(),this.inputFields.friends.focus()},SharedFolderDialog.prototype.setup=function(r,t){Dialog.prototype.setup.apply(this,arguments),this.containers.existingMembers&&(this.containers.existingMembers.initialize(e.getElementById("folderMembers")),this.showHideInviteInput())},SharedFolderDialog.prototype.showHideInviteInput=function(){LPProxy.isEnterpriseUser()||(this.containers.existingMembers.getItemChildren().length>5?($("#sharedFolderMaxMembers").show(),$("#sharedFolderDialogInvites").hide()):($("#sharedFolderMaxMembers").hide(),$("#sharedFolderDialogInvites").show()))},SharedFolderDialog.prototype.open=function(e){var r;this.folder=e,r=this,LPRequest.makeDataRequest(LPProxy.getSharedFolderMembers,{params:{shareid:e.getID()},success:function(t){for(var i=[],s=0,a=t.users.length;s<a;++s)i.push(new SharedFolderUser(t.users[s],e));for(s=0,a=t.groups.length;s<a;++s)i.push(new SharedFolderUserGroup(t.groups[s],e));for(r.containers.existingMembers=new Container(i),r.existingUsers={},s=0,a=i.length;s<a;++s)r.existingUsers[i[s].getID()]=!0;Dialog.prototype.open.call(r,{title:Strings.translateString("Manage Shared Folder")+": "+r.folder.getShareGroupName()})},error:function(){Topics.get(Topics.DIALOG_LOADED).publish()}})},SharedFolderDialog.prototype.getInvitedMembers=function(){var e=this.containers.newMembers?this.containers.newMembers.getItems():[];return e=e.concat(this.parseFriendsInput(this.inputFields.friends.getValue()))},SharedFolderDialog.prototype.getData=function(){var e=Dialog.prototype.getData.apply(this,arguments);e.newMembers={},e.updatedPermissions=[];var r=this.getInvitedMembers();if(r.length>0)for(var t=0,i=r.length;t<i;++t){var s=r[t];e.newMembers[s.getUsername()]={uid:s.getID(),type:s.getType()}}else{var a=this.containers.existingMembers.getItemChildren();for(t=0,i=a.length;t<i;++t){var n=a[t];n.isModified()&&e.updatedPermissions.push({uid:n.getID(!0),give:n.getCheckboxValue("give"),readonly:n.getCheckboxValue("readonly"),canadminister:LPProxy.isEnterpriseUser()?n.getCheckboxValue("can_administer"):"0"})}}return e},SharedFolderDialog.prototype.handleSubmit=function(e){var r=$.extend(e,{sharedFolder:this.folder._data,shareInfo:this.folder._shareInfo});LPTools.hasProperties(e.newMembers)?LPRequest.makeRequest(LPProxy.addSharedFolderMembers,{params:r,requestSuccessOptions:{closeDialog:!1},success:this.createDynamicHandler(function(r){for(var t=[],i=this.getInvitedMembers(),s=0,a=i.length;s<a;++s){var n=i[s];r[n.getUsername()]&&(n._pending=!1,n._data.readonly=e.readonly?"1":"0",n._data.give=e.hidePasswords?"0":"1",n._data.can_administer=e.can_administer?"1":"0",n.rebuild(),t.push(n)),n._parent&&n._parent.removeChild(n)}this.containers.existingMembers.addChild(t),this.showHideInviteInput(),this.inputFields.friends.clear()})}):e.updatedPermissions.length>0?LPRequest.makeRequest(LPProxy.updateSharedFolderMemberPermissions,{params:r,success:this.createHandler(function(){for(var r=this.containers.existingMembers.getItemChildren(),t={},i=0,s=r.length;i<s;++i){var a=r[i];t[a.getID(!0)]=a}for(i=0,s=e.updatedPermissions.length;i<s;++i){var n=e.updatedPermissions[i];t[n.uid].updatePermissions(n)}})}):this.close(!0)}}(document);
//# sourceMappingURL=sourcemaps/sharedFolderDialog.js.map
