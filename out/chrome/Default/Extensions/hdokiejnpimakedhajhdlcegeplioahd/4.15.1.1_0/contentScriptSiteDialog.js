var SiteDialog=function(t){DialogWithGroupInput.call(this,t,{confirmOnClose:!1,hideButtons:!0,hideHeader:!0,type:Account,additionalClasses:"lmiDialog",additionalDropdownClasses:"lmiDropdown"}),this.tiles=[],this.activeTile=null,this.selectedTile=null,this.isSelectable=!1,this.submitted=!1};SiteDialog.prototype=Object.create(DialogWithGroupInput.prototype),SiteDialog.prototype.constructor=SiteDialog,function(){SiteDialog.prototype.initialize=function(t){var e;DialogWithGroupInput.prototype.initialize.apply(this,arguments),e=this,t.on("click",".neverSave",function(){(e.data.generatedPasswordSaved||e.data.ezpass_test_saved)&&e.deleteItem(),bg.handleNeverURL({action:"never",cmd:"neverdomain",url:e.data.defaultData.url,fromsave:!0}),e.sendTrackingEvent("never"),bg.IntroTutorial.getState(function(t){t.enabled&&e.data.defaultData.url.includes(t.domain)?bg.IntroTutorial.completeTutorial({textChoice:"skipped"}):bg.IntroTutorial.resetState(),e.close()})}),t.on("input change",function(){(e.data.generatedPasswordSaved||e.data.ezpass_test_saved)&&e.nextButton.text(Strings.translateString("Update")),bg.Policies.getAccountSelectionBasedOnEmail(function(i){i&&bg.getLinkedAccount(function(i){var a=e.getData();i&&a.unencryptedUsername===bg.get("g_username")&&-1!==a.group.indexOf(i.group)?t.find("#submit").attr("disabled","disabled"):t.find("#submit").removeAttr("disabled")})})}),e.backButton=t.find("#close").bind("click",function(){e.data.generatedPassword?e.data.generatedPasswordSaved?(e.data.matchingSites&&0===e.data.matchingSites.length?e.$element.find("#undo").text(Strings.translateString("Yes, remove")):e.$element.find("#undo").text(Strings.translateString("Yes, undo")),e.dialogContent.css({height:e.dialogContent.css("height")}),e.$element.addClass("removeGeneratedConfirmation"),e.sendTrackingEvent("undo")):(e.sendTrackingEvent("discard"),e.close()):e.data.ezpass_test_saved?(e.sendTrackingEvent("undo"),e.deleteItem(function(){e.close()})):(e.sendTrackingEvent("notnow"),bg.IntroTutorial.getState(function(t){t.enabled&&e.data.defaultData.url.includes(t.domain)?bg.IntroTutorial.completeTutorial({textChoice:"skipped"}):bg.IntroTutorial.resetState(),e.close()}))}),e.nextButton=t.find("#submit").bind("click",function(){e.isSelectable?e.selectedTile&&e.submit():e.submit()}),t.find("#closeConfirmation").bind("click",function(){e.close()}),t.find("#undo").bind("click",function(){e.data.matchingSites&&0===e.data.matchingSites.length?e.deleteItem(function(){e.close()}):e.revertPasswordChange(function(){e.close()})}),t.find(".addNewSiteButton").bind("click",function(){var t=e.tiles.slice();e.defaultFields(e.data),e.originalData=e.getData(),e.populateFields(e.data.dialogData),e.setupAdd(),e.setSelectable(!1),$(this).LP_hide();for(var i=0;i<t.length;++i)t[i].remove()})};SiteDialog.prototype.deleteItem=function(t){this.vaultItem.deleteItem({confirm:!1,success:t})},SiteDialog.prototype.revertPasswordChange=function(t){this.vaultItem.revertPasswordChange({confirm:!1,success:t})},SiteDialog.prototype.sendTrackingEvent=function(t){var e=this.clickedEdit?"savesiteedit":"savesiteseen",i={action:t,newPassword:0===this.data.matchingSites.length,generatedPassword:this.data.generatedPassword&&(this.data.formSubmitted||!this.data.sameDomain),isAutoSaved:this.data.ezpass_test_saved,domain:this.data.defaultData.domain,domainSites:this.data.defaultData.domainSites};this.clickedEdit&&$.extend(i,{changedEmail:this.inputFields.unencryptedUsername.getValue()!==this.data.defaultData.unencryptedUsername,changedPassword:this.inputFields.password.getValue()!==this.data.dialogData.password,showedPassword:!!this.activeTile&&this.activeTile.showedPassword()}),bg.sendLpImprove(e,i)},SiteDialog.prototype.setupAdd=function(t){t=t||this.data,this.$element.find(".question").text(Strings.translateString("Add to LastPass?")),this.nextButton.text(Strings.translateString("Add"));var e=new this.SiteTile;t.defaultData.unencryptedUsername||e.showDetails({animate:!1,clearErrors:!0,tileHeight:"auto"})};var t=function(t,e,i){var a=$.extend({},t.defaultData);return e&&$.extend(a,e.getFormData($.extend(i,DialogInput.getProperties(t.dialogData),DialogInput.getProperties(t.defaultData)))),a},e=function(e,i,a){return $.extend(t(e,i,a),e.dialogData)};SiteDialog.prototype.hasDuplicates=function(){for(var t=0;t<this.tiles.length;++t)if(this.tiles[t].getDuplicates().length>0)return!0;return!1},SiteDialog.prototype.setup=function(i,a){a.saveOptions={source:"saveSite"},i.find(".addSiteFavicon").append(LPTools.createElement("img",{class:"favicon",src:a.favicon?a.favicon:"images/site/world.png"}));var n=this,s=i.find(".tileContainer"),o=i.find(".question"),l=i.find(".explanation"),r=i.find(".dialogForm"),d=i.find(".tile.template"),c=i.find(".deleteOverlayContainer.template"),u=function(t){for(var e={},i=t.find("[dialogFieldDisplay]"),a=0;a<i.length;++a)e[i[a].getAttribute("dialogFieldDisplay")]=!0;return e}(d),g=DialogInput.getProperties(n.inputFields),h=this.SiteTile=function(i){i=i||{};var a,o=this,l=d.clone().removeClass("template"),h=null,p=n.data,f=!1,m=!1,v=null,S=!1,D=t(p,i.site,g),b=e(p,i.site,g),y=null,w=function(t){t&&n.clearErrors(),n.originalData=D,n.populateFields(b)};this.showedPassword=function(){return S},this.getDialogData=function(){return b},this.getOriginalData=function(){return D},this.getOriginalDialogData=function(){return e(p,i.site,g)},this.getDuplicates=function(){if(null===y&&(y=[],p.defaultData.unencryptedUsername)){var t=bg.hostof(b.url);n.tiles.forEach(function(e){var i=e.getDialogData();e!==o&&bg.hostof(i.url)===t&&y.push(e)})}return y},this.handleHeightChange=(a=function(t,e){t=t||{};var i=LPTools.getOption(t,"animate",!0),a="animating";i&&(t.animationClass&&(a+=" "+t.animationClass),l.addClass(a));var n=function(t){l.removeClass(a),t&&t.transitionEndHandler&&t.transitionEndHandler(),e({callback:t&&t.onFrameResizeComplete})};t.change(function(e){var a,s,o,r=LPTools.getOption(e,"tileHeight",LPTools.getOption(t,"tileHeight",l.children().first().outerHeight())),d=l.height();return l.css("height",r),r!==d&&i?(s=function(){n(e)},o=function(t){t.target===this&&(a.unbind("transitionend",o),s())},(a=l).bind("transitionend",o)):n(e),r})},function(t){LPTools.getOption(t,"animate",!0)?n.requestAnimationFrame(function(e){a(t,e)}):a(t,function(t){n.setFrameSize(),t&&t.callback&&t.callback()})}),this.showDetails=function(t){n.sendTrackingEvent("edit"),this.handleHeightChange($.extend(t,{animationClass:"details-animatation",change:function(e){null===v&&(v=l.height()),n.activeTile&&n.activeTile!==o&&n.activeTile.hideDetails(t),n.activeTile=o,w(t&&t.clearErrors),l.find(".tileContent").append(r),l.addClass("details");var i=e();n.clickedEdit||(n.clickedEdit=!0,n.sendTrackingEvent("edit"),n.adjustView(!0),n.adjustScrollHeight(i-v))}}))},this.preSubmit=function(){n.activeTile!==this&&(n.activeTile&&(n.activeTile.hideDetails(),n.activeTile=null),w()),n.vaultItem=i.site,!n.vaultItem&&p.dialogData.fields&&(p.saveOptions.saveFromSubmit=!0)},this.hideDetails=function(t){b=n.getData();var e=r.clone();this.handleHeightChange($.extend(t,{animationClass:"details-animatation",change:function(t){l.find(".tileContent").append(e),l.removeClass("details"),t({transitionEndHandler:function(){e.remove()},tileHeight:v})}}))},this.unselect=function(){f&&(n.selectedTile=null,f=!1,l.removeClass("selected"),n.$element.removeClass("selected"),n.nextButton.prop("disabled",!0))},this.toggleSelect=function(){f?(this.unselect(),this.getDuplicates().forEach(function(t){t.hideDeleteOverlay()})):(this.getDuplicates().forEach(function(t){t.showDeleteOverlay()}),n.tiles.forEach(function(t){t.unselect()}),n.selectedTile=this,f=!0,l.addClass("selected"),n.$element.addClass("selected"),n.nextButton.prop("disabled",!1))},this.remove=function(){l.remove();for(var t=0;t<n.tiles.length;++t)if(n.tiles[t]===this){n.tiles.splice(t,1);break}},this.showDeleteOverlay=function(){null===h&&((h=c.clone().removeClass("template")).find(".cancelDeleteButton").bind("click",this.hideDeleteOverlay),h.find(".deleteButton").bind("click",function(){i.site.deleteItem({confirm:!1,success:function(){o.remove()}}),o.hideDeleteOverlay()})),l.append(h),l.addClass("duplicate")},this.hideDeleteOverlay=function(){l.removeClass("duplicate"),h.one("animationend",function(){l.hasClass("duplicate")||h.detach()})},this.setSelectable=function(t){m=t;var e=l.find(".favicon");m?(e.addClass("hoverFadeOut"),l.find(".checkmark").LP_show()):(e.removeClass("hoverFadeOut"),l.find(".checkmark").LP_hide()),n.setSelectable(t)},l.find(".tileEdit").bind("click",function(){o.showDetails({clearErrors:!0})}),l.find(".checkmark").bind("click",function(){o.toggleSelect()}),l.on("click",".showPassword",function(){S=!0}),s.append(l),function(t,e){for(var i=t.find("[dialogFieldDisplay]"),a=0;a<i.length;++a){var n=i[a],s=e[n.getAttribute("dialogFieldDisplay")];s&&(n.textContent=s)}}(l,i.site?i.site.getFormData(u):p.defaultData),n.tiles.push(this)};if(a.matchingSites)if(0===a.matchingSites.length)a.generatedPasswordSaved?(o.text(Strings.translateString("This site has been added to your LastPass vault")),this.nextButton.text(Strings.translateString("OK")),this.backButton.text(Strings.translateString("Remove")),new h({site:a.vaultItem})):n.data.ezpass_test_saved?(o.text(Strings.translateString("This site has been added to your LastPass vault")),this.nextButton.text(Strings.translateString("OK")),this.backButton.text(Strings.translateString("Remove")),new h({site:a.vaultItem})):this.setupAdd(a);else if(1===a.matchingSites.length)a.generatedPasswordSaved?(o.text(Strings.translateString("We've updated your password")),this.nextButton.text(Strings.translateString("OK")),this.backButton.text(Strings.translateString("Undo"))):(o.text(Strings.translateString("Update password?")),this.nextButton.text(Strings.translateString("Update")),a.defaultData.unencryptedUsername&&a.matchingSiteSameSubDomain||i.find(".addNewSiteButton").LP_show()),a.vaultItem=LPProxy.getSiteModel(a.matchingSites[0]),new h({site:a.vaultItem});else{for(var p=0;p<a.matchingSites.length;++p)new h({site:LPProxy.getSiteModel(a.matchingSites[p])}).setSelectable(!0);o.text(Strings.translateString("Which account should we update?")),a.defaultData.unencryptedUsername?this.hasDuplicates()&&l.text(Strings.translateString("Choose one to update and delete the duplicate.")):i.find(".addNewSiteButton").LP_show(),this.nextButton.text(Strings.translateString("Update"))}!a.generatedPassword||a.generatedPasswordSaved||a.sameDomain||(o.text(Strings.translateString("Oops! What would you like to do with your generated password?")),this.backButton.text(Strings.translateString("Discard"))),DialogWithGroupInput.prototype.setup.apply(this,arguments),this.inputFields.unencryptedUsername.setValues(LPProxy.getSiteUsernames()),this.inputFields.unencryptedUsername.disableClickToggle()},SiteDialog.prototype.setSelectable=function(t){t?(this.$element.addClass("selectable"),this.nextButton.prop("disabled",!0)):(this.$element.removeClass("selectable"),this.nextButton.prop("disabled",!1))},SiteDialog.prototype.validate=function(t){var e=DialogWithGroupInput.prototype.validate.apply(this,arguments);return""===t.unencryptedUsername&&(this.addError("unencryptedUsername",Strings.translateString("Please enter a username.")),e=!1),e},SiteDialog.prototype.getDialogActions=function(t){},SiteDialog.prototype.close=function(t){bg.LPTabState.clear({force:!0}),DialogWithGroupInput.prototype.close.apply(this,arguments)},SiteDialog.prototype.saveGeneratedPassword=function(i,a){var n;if(i.generatedPassword&&i.formSubmitted&&i.defaultData.unencryptedUsername)if(0===i.matchingSites.length)n=e(i),(new Account).addFromDialog(n,this.getGroup(n),{success:function(t){i.vaultItem=t,i.generatedPasswordSaved=!0,bg.LPTabState.clear({force:!0}),a()}});else if(1===i.matchingSites.length&&i.matchingSiteSameSubDomain){var o=LPProxy.getSiteModel(i.matchingSites[0]);n=e(i,o),s(n,t(i,o),n),o.saveFromDialog(n,this.getGroup(n),{success:function(t){i.vaultItem=t,i.generatedPasswordSaved=!0,bg.LPTabState.clear({force:!0}),a()}})}else a();else i.ezpass_test&&i.formSubmitted&&i.defaultData.unencryptedUsername&&0===i.matchingSites.length?(n=e(i),(new Account).addFromDialog(n,this.getGroup(n),{success:function(t){i.vaultItem=t,i.ezpass_test_saved=!0,bg.LPTabState.clear({force:!0}),a()}})):a()},SiteDialog.prototype.open=function(t){var e=this;this.saveGeneratedPassword(t,function(){var i,a;i=t,a=function(i){t.favicon=i,DialogWithGroupInput.prototype.open.call(e,t)},bg.LPIcons.get({url:i.defaultData.url,square:!0,callback:function(t){if(t)a(t);else{var e=function(){bg.LPPlatform.getFavicon({url:i.defaultData.url,callback:a})};i.sameDomain?csTop.LPContentScriptTools.getFavicon(function(t){t?a(t):e()}):e()}}})})},SiteDialog.prototype.adjustScrollHeight=function(t){this.scrollHeight&&(this.scrollHeight+=t,this.tileContainer.css({"max-height":this.scrollHeight}))},SiteDialog.prototype.setInitialScrollHeight=function(){if(this.tiles.length>3){this.tileContainer=this.$element.find(".tileContainer");var t=this.tileContainer.height(),e=this.$element.find(".tile").first().height(),i=(t-e*this.tiles.length)/(this.tiles.length-1);this.scrollHeight=3.5*e+3*i,this.tileContainer.css({overflow:"auto","max-height":this.scrollHeight})}},SiteDialog.prototype.showInitial=function(){var t;(t=this).requestAnimationFrame(function(e){t.show(),t.setInitialScrollHeight(),t.$element.addClass("animate-enter").one("animationend",function(){t.$element.removeClass("animate-enter"),e()})})};var i=null,a=!1;SiteDialog.prototype.showInProcessOverlay=function(){if(this.submitted){var t=this.$element;t.addClass("inProcess").one("animationend",function(){t.addClass("waiting"),setTimeout(function(){a=!0,i&&i()},500)})}},SiteDialog.prototype.hideInProcessOverlay=function(){this.$element.removeClass("inProcess waiting")},SiteDialog.prototype.closeOnSuccess=function(){if(this.submitted){bg.get("LPContentScriptFeatures").new_save_site&&bg.sendTimingEvent("addSite","stop");var t=this;t.$element.addClass("inProcess waiting");var e=function(){t.$element.removeClass("waiting").addClass("success").one("animationend.success",function(){setTimeout(function(){t.close()},500)})};a?e():i=function(){setTimeout(function(){e()},0)}}},SiteDialog.prototype.performValidate=function(t){var e=this;if(e.selectedTile)if(e.selectedTile===e.activeTile)e.activeTile.handleHeightChange({change:function(i){var a=t.callback;t.callback=function(){var t=arguments;i({onFrameResizeComplete:function(){a&&a.apply(e,t)}})},DialogWithGroupInput.prototype.performValidate.call(e,t)}});else{var i=t.callback;t.callback=function(t){t||e.selectedTile.showDetails(),i&&i.apply(this,arguments)},DialogWithGroupInput.prototype.performValidate.call(e,t)}},SiteDialog.prototype.getErrorOptions=function(){return{static:!0,alignTop:!0,showErrorLabel:!1}},SiteDialog.prototype.submit=function(){bg.get("LPContentScriptFeatures").new_save_site&&bg.sendTimingEvent("addSite","resume"),1===this.tiles.length&&(this.selectedTile=this.tiles[0]),this.selectedTile.preSubmit(),DialogWithGroupInput.prototype.submit.apply(this,arguments),this.vaultItem?this.sendTrackingEvent("update"):this.sendTrackingEvent("add")};var n=function(t,e){t.fields&&t.fields.forEach(function(i){t.unencryptedUsername&&t.unencryptedUsername===i.value&&"password"!==i.type?i.value=e.unencryptedUsername:"password"===i.type&&(i.value=e.password)})},s=function(t,e,i){if(i.fields){n(e,i),n(t,i);var a=e.fields?e.fields:[];t.fields&&(a=a.concat(t.fields.filter(function(t){for(var e=0;e<a.length;++e){var i=a[e];if(t.type===i.type&&t.name===i.name&&t.formname===i.formname)return!1}return!0}))),i.fields=a}};SiteDialog.prototype.handleSubmit=function(t){this.submitted=!0,s(this.selectedTile.getOriginalDialogData(),this.selectedTile.getOriginalData(),t),DialogWithGroupInput.prototype.handleSubmit.apply(this,arguments)}}();
//# sourceMappingURL=sourcemaps/contentScriptSiteDialog.js.map
