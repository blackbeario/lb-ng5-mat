var g_db=null,g_indexeddb=!1;function opendb(){try{if(getBG().g_db_transaction_tested&&!getBG().g_db_transaction_worked)return null;if(null!=g_db)return g_db;if(window.openDatabase)(g_db=openDatabase("lp","1.0","LastPass Local Database",2e5))||console_log("opendb: Failed to open database!");else if(window.indexedDB){var e=indexedDB.open("lp");e.onerror=function(e){indexedDB.deleteDatabase("lp")},e.onsuccess=function(e){g_indexeddb=!0,g_db=e.target.result},e.onupgradeneeded=function(e){var a=e.target.result.createObjectStore("LastPassData",{keyPath:"usertype"});a.createIndex("username_hash","username_hash",{unique:!1}),(a=e.target.result.createObjectStore("LastPassSavedLogins2",{keyPath:"username"})).createIndex("last_login","last_login",{unique:!1}),(a=e.target.result.createObjectStore("LastPassPreferences",{keyPath:"userkey"})).createIndex("username_hash","username_hash",{unique:!1})}}else console_log("opendb: open database is not available!")}catch(e){console_log("opendb: Caught exception while opening database: "+e.message)}return g_db}function createDataTable(e){e&&!g_indexeddb&&e.transaction(function(e){e.executeSql("CREATE TABLE IF NOT EXISTS LastPassData(id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, username_hash varchar(255), type varchar(20), data TEXT, CONSTRAINT usertype UNIQUE (username_hash, type))",[],function(e,a){},function(e,a){console_log("createDataTable"+a)})})}function createSavedLoginsTable(e){e&&!g_indexeddb&&(e.transaction(function(e){e.executeSql("CREATE TABLE IF NOT EXISTS LastPassSavedLogins(username varchar(255) PRIMARY KEY, password varchar(255), last_login datetime)",[],function(e,a){},function(e,a){console_log("createSavedLoginsTable1"+a),alert("executeSQL access is broken. Safari has a bug with Private Browsing that causes this issue.  Restarting Safari typically fixes it. Error: "+a.message+"\nCode: "+a.code)})}),e.transaction(function(e){e.executeSql("CREATE TABLE IF NOT EXISTS LastPassSavedLogins2(username varchar(255) PRIMARY KEY, password text, last_login datetime, protected tinyint(1))",[],function(e,a){},function(e,a){console_log("createSavedLoginsTable2"+a)})}),e.transaction(function(e){e.executeSql("SELECT * FROM LastPassSavedLogins order by last_login desc",[],function(e,a){for(var t=0;t<a.rows.length;t++){var s=a.rows.item(t).username;e.executeSql("REPLACE INTO LastPassSavedLogins2 (username, password, last_login) VALUES(?, ?, ?)",[s,a.rows.item(t).password,a.rows.item(t).last_login],function(e,a){},function(e,a){console_log(a)}),e.executeSql("DELETE FROM LastPassSavedLogins",[],function(e,a){},function(e,a){console_log(a)})}},function(e,a){console_log("createSavedLoginsTable6"+a)})}))}function lpSaveData(e,a){if(!lpdisableoffline||"key"!=a&&"accts"!=a)if(null!=g_username&&""!=g_username)if(""!=e||!LPISLOC||"key"!=a&&"accts"!=a){var t=opendb();createDataTable(t),t?(console_log("db.js : lpSaveData : writing data : type="+a),g_indexeddb?t.transaction("LastPassData","readwrite").objectStore("LastPassData").put({username_hash:db_prepend(g_username_hash),type:a,data:e,usertype:db_prepend(g_username_hash)+"_"+a}):t.transaction(function(t){t.executeSql("REPLACE INTO LastPassData (username_hash, type, data) VALUES (?, ?, ?)",[db_prepend(g_username_hash),a,e],function(e,t){console_log("db.js : lpSaveData : success : type="+a)},function(e,a){console_log("db.js : lpSaveData : failed error="+a)})})):console_log("server.js : lpSaveData : returning D")}else console_log("db.js : lpSaveData : returning C");else console_log("db.js : lpSaveData : returning B");else console_log("db.js : lpSaveData : returning A")}function createPrefsTable(e){e&&!g_indexeddb&&e.transaction(function(e){e.executeSql("CREATE TABLE IF NOT EXISTS LastPassPreferences (id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, username_hash varchar(255), prefname varchar(255), prefvalue varchar(255), CONSTRAINT userkey UNIQUE (username_hash, prefname))",[],function(e,a){},function(e,a){console_log("createPrefsTable: "+a)})})}function deletesavedpw(){var e=opendb();createSavedLoginsTable(e),e&&(g_indexeddb?e.transaction("LastPassSavedLogins2","readonly").objectStore("LastPassSavedLogins2").openCursor(IDBKeyRange.only(g_username)).onsuccess=function(a){a.target.result&&""!=a.target.result.value.password&&(a.target.result.value.password="",e.transaction("LastPassSavedLogins2","readwrite").objectStore("LastPassSavedLogins2").put(a.target.result.value),g_master_password_saved=!1)}:e.transaction(function(e){e.executeSql("UPDATE LastPassSavedLogins2 SET password = '' WHERE username = ?",[g_username],function(e,a){g_master_password_saved=!1},function(e,a){console_log("deletesavedpw:"+a)})}))}function protect_data(e,a,t,s){if(e.length)if(!a||g_is_win)if(is_chrome_portable())s(e);else{var n="";""==e&&!g_is_mac||!have_binary_function("protect_data")?(""==n&&(n=e),s(n)):call_binary_function("protect_data",e,t,function(a){"string"!=typeof a&&(a=""),""==a&&(a=e),s(a)})}else s(e);else s(e)}function unprotect_data(e,a,t){if(void 0!==e)if(e.length)if(!a||g_is_win)if(is_chrome_portable())t(e);else{var s="";""!=e&&have_binary_function("unprotect_data")?call_binary_function("unprotect_data",e,function(a){"string"!=typeof a&&(a=""),a==e&&(a=""),t(a)}):(s==e&&(s=""),t(s))}else t(e);else t(e);else t(null)}function set_default_login_username(e){var a=opendb();if(createSavedLoginsTable(a),a){var t=(new Date).getTime();g_indexeddb?a.transaction("LastPassSavedLogins2","readonly").objectStore("LastPassSavedLogins2").openCursor(IDBKeyRange.only(e)).onsuccess=function(s){var n;n=s.target.result?s.target.result.value:{username:e,password:"",last_login:t,protected:0},a.transaction("LastPassSavedLogins2","readwrite").objectStore("LastPassSavedLogins2").put(n)}:a.transaction(function(a){a.executeSql("INSERT OR IGNORE INTO LastPassSavedLogins2 (username, password, last_login) VALUES (?, '', ?)",[e,t],function(a,s){a.executeSql("UPDATE LastPassSavedLogins2 SET last_login = ? WHERE username = ?",[t,e])},function(e,a){console_log(a)})})}}
//# sourceMappingURL=sourcemaps/db.js.map
