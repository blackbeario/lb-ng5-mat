!function(){new RegExp(base_url||lp_base,"gi");var e=oneMinuteSignupMessageType,r=oneMinuteSignup.ScriptState,n=oneMinuteSignup.ScriptType,a=new oneMinuteSignup.TabService,t=null,p=null,i=null;function o(e,n){n&&(n.currentState===r.done?oneMinuteSignup.MessageService.sendLog(n.appId,n.type,"Script done but got Error"):(n.setState(r.done),a.closeTab(n),e&&e.error&&(e.error.message=JSON.stringify({exception:e.error.message,loginUrl:n.appLoginUrl,appName:n.appName,appId:n.appId,scriptType:n.type,url:n.url})),oneMinuteSignup.MessageService.sendError(e||{},n.appId,n.url,n.type)))}function s(e){e.setState(r.done),a.closeTab(e);var n=new Error("Script timeout"),t={error:{name:n.name,stack:n.stack,message:JSON.stringify({exception:"Script timeout",loginUrl:e.appLoginUrl,appName:e.appName,appId:e.appId,scriptType:e.type,url:e.url})},type:oneMinuteSignupMessageType.Error,appId:"",scriptType:""};oneMinuteSignup.MessageService.sendError(t,e.appId,e.url,e.type)}oneMinuteSignup.ExtensionProxyService.onMessage(function(u,c,d){var g,l,S,y,v,b,m,M,f,T=a.getTabPropertiesByTabId(c);switch(u.type){case e.ResetRequestScript:case e.ResetScript:case e.LogoutScript:t=c,oneMinuteSignup.MessageService.tabId=c,(f=u).data&&f.data.forEach(function(t){var p=t.appId,i=a.getTabPropertiesByAppId(p);if(i.currentState!==r.done&&oneMinuteSignup.MessageService.sendLog(i.appId,i.type,"Script running not in done state"),i.setState(r.running),i.setTimeout(s),i.appLoginUrl=t.appLoginUrl||t.url,i.appName=t.appName,i.url=t.url,i.username=t.username,i.activeScript=t.script,f.type===e.ResetRequestScript)i.type=n.request,i.activeTriggerScript=oneMinuteSignup.AppService.getTriggerScript(n.request,t.username);else if(f.type===e.ResetScript){i.type=n.change;var u=oneMinuteSignup.AppService.generatePassword(t.passwordPolicy);console.log(t.url,u),i.newPassword=u,i.activeTriggerScript=oneMinuteSignup.AppService.getTriggerScript(n.change,u)}else f.type===e.LogoutScript&&(i.type=n.logout,i.activeTriggerScript=oneMinuteSignup.AppService.getTriggerScript(n.logout));if(console.log("App: "+i.appId+" Clear cookies"),t.url)a.createTabOrNavigate(i,function(e){});else{var c=new Error("No "+t.scriptType+"url found on "+t.appName);o({error:c},i)}}),d();break;case e.Done:console.log("DONE APP",T,c),(M=T)&&(M.clearTimeout(),M.currentState===r.done?oneMinuteSignup.MessageService.sendLog(M.appId,M.type,"Script running already in done state"):(M.currentState===r.suspended&&oneMinuteSignup.ExtensionProxyService.focusTabById(t),M.setState(r.done),a.closeTab(M),oneMinuteSignup.MessageService.sendDone(M.appId,M.type),M.type===n.change&&function(e,r,n,a,t){var p=get_default_group(n),i={url:n,formdata2:"",group:p&&!g_nofolder_feature_enabled?p:"(none)",name:e,username:a,password:t,notes:"",orig_username:a,orig_password:t};if(!lploggedin)return null;var n=punycode.URLToASCII(i.url),o=i.formdata2,s=i.name,u=i.group,c=i.username,t=i.password,d=i.orig_username,g=i.orig_password,l=null!=o&&o.length>0,S=issharedfolder(g_shares,u);if(!checkreadonly(S))return{error:gs("Sorry, this shared folder is read-only.")};var y=0==S?g_local_key:S.sharekey,v=createNewAcct(),b=lp_gettld_url(AES._utf8_encode(n));v.genpw=!1,v.name=s,v.group=u,v.url=AES._utf8_encode(n),v.tld=b,v.unencryptedUsername=c,v.username=lpmenc(c,!0,y),v.password=lpmenc(t,!0,y),v.extra="",v.fav=0,v.autologin=0,v.never_autofill=0,v.pwprotect=0,v.aid="0",0!=S&&(v.sharefolderid=S.id,0==S.give&&(v.sharedfromaid=1));var m=u;S&&(m=u.substr(S.decsharename.length+1)),v.fields=new Array,v.save_all=i.save_all?1:0;var M=[],f={save_all:0,username:d,password:g,new_username:c,new_password:t,fromiframe:1},T=updateAndEncryptData(o,v.fields,M,v,y,f),I="name="+en(lpenc(s,y))+"&grouping="+en(lpenc(m,y))+"&data="+en(bin2hex(T))+"&extra="+en(lpenc("",y));if(I+="&extjs=1&localupdate=1",I+=0==S?"":"&sharedfolderid="+en(S.id),v.newvalues=M,l)I+="&ref="+en(AES.url2hex(n));else{I+="&aid=0",I+="&url="+en(AES.url2hex(n)),I+="&openid_url=",I+="&username="+en(crypto_btoa(v.username)),I+="&password="+en(crypto_btoa(v.password)),I+="&auto=1"+get_identity_param();var _=is_application(v),h=(_?v.appaid:v.aid,{url:base_url+(_?"addapp.php":"show.php"),postdata:I,successCallback:function(e,n){var a=e.responseXML.documentElement.getElementsByTagName("result")[0];if(a){var p=a.getAttribute("action");if("added"===p){var i=a.getAttribute("aid");oneMinuteSignup.MessageService.sendSavedToVault(r,u,t,i)}}},acct:v});lpMakeRequest(h.url,I,h.successCallback,h.successCallback,i)}}(M.appName,M.appId,M.appLoginUrl,M.username,M.newPassword))),d();break;case e.Error:o(u,T),d();break;case e.NavigateToTab:b=u,m=a.getTabPropertiesByAppId(b.appId),oneMinuteSignup.ExtensionProxyService.focusTabById(m.tabId),d();break;case e.UserInformationNeeded:(v=T)&&(v.currentState===r.done?oneMinuteSignup.MessageService.sendLog(v.appId,v.type,"Script done but got UseInfoNeeded"):(v.clearTimeout(),v.setState(r.suspended),oneMinuteSignup.MessageService.sendUserInfoNeeded(v.appId,v.type))),d();break;case e.GetToken:t=c,oneMinuteSignup.MessageService.tabId=c,oneMinuteSignup.MessageService.sendToken(),d();break;case e.LaunchApplication:oneMinuteSignup.ExtensionProxyService.createTab(u.data.url,!0,function(){}),d();break;case e.CloseTab:S=u,y=a.getTabPropertiesByAppId(S.appId),a.closeTab(y),d();break;case e.GetOauthToken:t=c,oneMinuteSignup.MessageService.tabId=c,l=u,i=c,a.createTab({url:l.url},function(e){p=e,a.focusTabById(e)}),d();break;case e.ReceivedOauthToken:g=u,oneMinuteSignup.ExtensionProxyService.focusTabById(i),oneMinuteSignup.MessageService.sendOauthToken(g.token,g.state),a.closeTab({tabId:p}),d()}}),oneMinuteSignup.ExtensionProxyService.onUpdateTab(function(e,r){var n=a.getTabPropertiesByTabId(e);n&&(console.log("App: "+n.appId+" Change url",r),n.currentState!==oneMinuteSignup.ScriptState.done&&(console.log("App: "+n.appId+" Execute script"),oneMinuteSignup.ExtensionProxyService.executeScriptWithFrameWork(n)))})}();
//# sourceMappingURL=sourcemaps/1minsignup/background.js.map
