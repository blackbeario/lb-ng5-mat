var LPModule,__extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();!function(e){setTimeout(function(){e.initialize(),e.postInitialize()})}(LPModule||(LPModule={})),function(e){var t;(t=e.ServiceType||(e.ServiceType={})).BasicAuth="BasicAuth",t.FormParser="FormParser",t.SiteParser="SiteParser",t.StringUtils="StringUtils"}(LPModule||(LPModule={})),function(e){var t=new(function(){function e(){this.constructors={},this.services={}}return e.prototype.register=function(e,t){this.constructors[e]=t},e.prototype.initialize=function(){var e=this;Object.keys(this.constructors).forEach(function(t){return e.services[t]=new e.constructors[t]}),Object.keys(this.services).forEach(function(t){return e.services[t].initialize()})},e.prototype.getService=function(e){return this.services[e]},e}());e.getService=function(e){return t.getService(e)},function(e){e.initialize=function(){t.initialize()},e.register=function(e,r){t.register(e,r)}}(e.Services||(e.Services={}))}(LPModule||(LPModule={})),function(e){var t,r,i;t=e.Services||(e.Services={}),r=t.Utils||(t.Utils={}),i=function(){function e(){}return e.prototype.initialize=function(){},e.prototype.stringContains=function(e,t){if(e&&t){Array.isArray(t)||(t=[t]);for(var r=0;r<t.length;++r)if(e.indexOf(t[r])>-1)return!0}return!1},e}(),r.StringUtilsService=i}(LPModule||(LPModule={})),function(e){e.initialize=function(){e.Services.initialize()},e.postInitialize=function(){e.Services.postInitialize()}}(LPModule||(LPModule={})),function(e){!function(t){(e.Services||(e.Services={})).postInitialize=function(){window.basicAuth=e.getService(e.ServiceType.BasicAuth)}}()}(LPModule||(LPModule={})),function(e){var t,r,i;t=e.Services||(e.Services={}),r=t.BasicAuth||(t.BasicAuth={}),i=function(e,t,r,i){void 0===t&&(t=""),void 0===r&&(r=""),void 0===i&&(i=!1),this.url=e,this.userName=t,this.password=r,this.suppliedBefore=i,this.cancelled=!1},r.AuthCredential=i}(LPModule||(LPModule={})),function(e){var t,r,i;t=e.Services||(e.Services={}),r=t.BasicAuth||(t.BasicAuth={}),i=function(){function e(){this.authCredentials={}}return e.prototype.initialize=function(){this.subscribeEvents()},e.prototype.subscribeEvents=function(){var e=this;LPPlatform.onAuthRequired(function(t,i){if(g_basicauth_feature_enabled&&"basic"===t.scheme){var s=e.authCredentials[t.tabId];if(s&&!s.cancelled&&!s.suppliedBefore)return e.authCredentials[t.tabId]=new r.AuthCredential(t.url,s.userName,s.password,!0),e.removeAuth(i),{authCredentials:{username:s.userName,password:s.password}};if(!s)return e.authCredentials[t.tabId]=new r.AuthCredential(t.url),{cancel:!0}}}),LPPlatform.onTabClosed(function(t){e.removeAuth(t)})},e.prototype.removeAuth=function(e){this.authCredentials[e]&&delete this.authCredentials[e]},e.prototype.isBasicAuth=function(e,t){var r=this.authCredentials[t.tabID];if(r){if(r.url!==t.tabURL)return e(!1,!1),void this.removeAuth(t.tabID);if(!r.cancelled)return void e(!0,r.suppliedBefore)}e(!1,!1)},e.prototype.setAuthCredential=function(e,t,r,i){var s=this.authCredentials[i.tabID];s.userName=e,s.password=t,r()},e.prototype.cancelBasicAuth=function(e){this.authCredentials[e.tabID]&&(this.authCredentials[e.tabID].cancelled=!0)},e.prototype.hasFeature=function(e){e(!0)},e.prototype.isNotificationClosed=function(e){e("closed"===localStorage_getItem("basicAuthPopupState"))},e.prototype.closeNotification=function(){localStorage_setItem("basicAuthPopupState","closed")},e}(),r.BasicAuthService=i,t.register(e.ServiceType.BasicAuth,i)}(LPModule||(LPModule={})),function(e){var t,r,i;t=e.Services||(e.Services={}),r=t.FormParser||(t.FormParser={}),i=function(){function e(e){var t=this;this.passwordsByValue={},this.textFieldsByValue={},this.textFieldsByType={},this.uniqueTextValues=[],this.uniquePasswords=[],e.fields&&(e.fields.forEach(function(e){"password"===e.type?t.aggregateField(e,e.value,t.passwordsByValue):(t.aggregateField(e,e.value,t.textFieldsByValue),t.aggregateField(e,e.type,t.textFieldsByType))}),this.uniqueTextValues=Object.keys(this.textFieldsByValue),this.uniquePasswords=Object.keys(this.passwordsByValue))}return e.prototype.aggregateField=function(e,t,r){var i=r[t];i?++i.count:r[t]={field:e,count:1}},e}(),r.FormMetaData=i}(LPModule||(LPModule={})),function(e){var t,r,i;t=e.Services||(e.Services={}),r=t.FormParser||(t.FormParser={}),i=function(){function e(){}return e.prototype.initialize=function(){},e.prototype.parse=function(e,t,i){return new r.ParsedForm(e,t,i)},e}(),r.FormParserService=i,t.register(e.ServiceType.FormParser,i)}(LPModule||(LPModule={})),function(e){var t,r,i;t=e.Services||(e.Services={}),r=t.FormParser||(t.FormParser={}),i=function(){function t(t,i,s){this.formData=null,this.userNameField=null,this._succeeded=!1,this._submitted=!1;var n=e.getService(e.ServiceType.SiteParser);i.fields=i.fields||[];var a=new r.FormMetaData(i);if(!i.password)if(i.generatedPassword)i.password=i.generatedPassword;else{var o=(new r.FieldParsers.PasswordFieldParser).parse(i,a,t);"string"==typeof o&&(i.password=o)}var u=new r.FieldParsers.UserNameFieldParser(s&&s.strict).parse(i,a,t),l=[];if("string"==typeof u&&(l=t.getSites().filter(function(e){return n.hasMatchingSiteUserName(e,u)}),i.username&&0===l.length&&!i.createAccountForm||(i.username=u)),i.username&&!i.createAccountForm)for(var c=0,d=i.fields;c<d.length;c++){var f=d[c];if(f.value===i.username){this.userNameField=f;break}}this.formData=i,this._submitted=!i.generatedPassword}return t.prototype.submitted=function(e){return"boolean"==typeof e&&(this._submitted=e),this._submitted},t.prototype.succeeded=function(e){return"boolean"==typeof e&&(this._succeeded=e),this._succeeded},t.prototype.getUsernameField=function(){return this.userNameField},t.prototype.getUsername=function(){return this.formData.username},t.prototype.getPassword=function(){return this.formData.password},t.prototype.getOriginalPassword=function(){return this.formData.originalPassword},t.prototype.getFormData=function(){return this.formData},t.prototype.getFields=function(){return this.formData.fields},t.prototype.isChangePasswordForm=function(){return!!this.formData.passwordChangeForm},t.prototype.isCreateAccountForm=function(){return!!this.formData.passwordChangeForm},t.prototype.isBasicAuthentication=function(){return!!this.formData.basicAuthentication},t.prototype.shouldSaveFields=function(){return!this.isChangePasswordForm()&&!this.isCreateAccountForm()},t.prototype.getURL=function(){return this.formData.url},t}(),r.ParsedForm=i}(LPModule||(LPModule={})),function(e){var t,r,i,s;t=e.Services||(e.Services={}),r=t.FormParser||(t.FormParser={}),i=r.FieldParsers||(r.FieldParsers={}),s=function(){function e(){this.operations=[]}return e.regexMatches=function(e,t){var r=!1;if(e){var i=function(e,t){return"string"==typeof t&&e.test(t.toLowerCase())};Array.isArray(t)?t.forEach(function(t){return r=r||i(e,t)}):r=i(e,t)}return r},e.getFormFieldRegex=function(e){var t=get_ff_translation(e);if(t)return new RegExp(t)},e.prototype.parse=function(e,t,r){for(var i=null,s=0,n=this.operations;s<n.length&&!(i=(0,n[s])(e,t,r))&&!1!==i;s++);return i},e}(),i.FieldParserAbstract=s}(LPModule||(LPModule={})),function(e){var t,r,i,s;t=e.Services||(e.Services={}),r=t.FormParser||(t.FormParser={}),i=r.FieldParsers||(r.FieldParsers={}),s=function(t){function r(){var s=t.call(this)||this;return s.stringUtils=e.getService(e.ServiceType.StringUtils),s.siteParser=e.getService(e.ServiceType.SiteParser),r.excludedFields.length||(r.excludedFields=[{type:"attr",regex:i.FieldParserAbstract.getFormFieldRegex("ff_ssn_regexp")},{type:"attr",regex:i.FieldParserAbstract.getFormFieldRegex("ff_cccsc_regexp")},{type:"attr",regex:i.FieldParserAbstract.getFormFieldRegex("ff_securityanswer_regexp")},{type:"attr",regex:i.FieldParserAbstract.getFormFieldRegex("ff_captcha_regexp")},{type:"text",regex:i.FieldParserAbstract.getFormFieldRegex("ff_text_ssn_regexp")},{type:"text",regex:i.FieldParserAbstract.getFormFieldRegex("ff_text_cccsc_regexp")}]),s.operations=[s.excludedFieldOperation,s.singlePasswordFieldOperation,s.multiplePasswordOperation,s.multiplePasswordsOneExistingOperation,s.passwordLikeAttribute],s}return __extends(r,t),r.prototype.excludedFieldOperation=function(e,t,s){for(var n=0;n<e.fields.length;++n)for(var a=e.fields[n],o=0;o<r.excludedFields.length;++o){var u=r.excludedFields[o];if(u.regex){if("attr"===u.type&&i.FieldParserAbstract.regexMatches(u.regex,[a.id,a.attributes.name]))return!1;if("text"===u.type&&i.FieldParserAbstract.regexMatches(u.regex,a.label))return!1}}return null},r.prototype.singlePasswordFieldOperation=function(e,t,r){if(1===t.uniquePasswords.length){var i=t.uniquePasswords[0];return 2===t.passwordsByValue[i].count&&(2===e.fields.length?e.passwordChangeForm=!0:e.createAccountForm=!0),i}return null},r.prototype.multiplePasswordOperation=function(e,t,r){for(var i=0,s=t.uniquePasswords;i<s.length;i++){var n=s[i];if(t.passwordsByValue[n].count>1)return 2===t.uniquePasswords.length?(e.passwordChangeForm=!0,e.originalPassword=t.uniquePasswords[0]===n?t.uniquePasswords[1]:t.uniquePasswords[0]):e.createAccountForm=!0,n}return null},r.prototype.multiplePasswordsOneExistingOperation=function(e,t,r){if(2===t.uniquePasswords.length){var i=this.findMatchingPassword(r.getSites(),t.uniquePasswords);if(i)return e.passwordChangeForm=!0,e.originalPassword=i,t.uniquePasswords[0]===i?t.uniquePasswords[1]:t.uniquePasswords[0]}return null},r.prototype.passwordLikeAttribute=function(e,t,r){for(var i=0,s=t.uniquePasswords;i<s.length;i++){var n=s[i],a=t.passwordsByValue[n].field,o=["pw","pass"];if(this.stringUtils.stringContains(a.attributes.name,o)||this.stringUtils.stringContains(a.id,o))return n}},r.prototype.findMatchingPassword=function(e,t){for(var r=0;r<e.length;++r){var i=this.siteParser.findMatchingSitePassword(e[r],t);if(i)return i}return null},r.excludedFields=[],r}(i.FieldParserAbstract),i.PasswordFieldParser=s}(LPModule||(LPModule={})),function(e){var t,r,i,s;t=e.Services||(e.Services={}),r=t.FormParser||(t.FormParser={}),i=r.FieldParsers||(r.FieldParsers={}),s=function(t){function r(r){var s=t.call(this)||this;return s.isStrict=r,s.userNameRegEx=i.FieldParserAbstract.getFormFieldRegex("ff_username_regexp"),s.stringUtils=e.getService(e.ServiceType.StringUtils),s.isStrict?s.operations=[s.userNameLikeLabelOperation,s.userNameLikeAttributeOperation]:s.operations=[s.userNameLikeLabelOperation,s.singleTextFieldOperation,s.multipleTextFieldOperation,s.nearPasswordFieldOpeartion,s.existingUserNameOperation,s.uniqueEmailFieldOperation,s.userNameLikeAttributeOperation],s}return __extends(r,t),r.prototype.userNameLikeLabelOperation=function(e,t,r){if(this.userNameRegEx)for(var s=0,n=e.fields;s<n.length;s++){var a=n[s];if(i.FieldParserAbstract.regexMatches(this.userNameRegEx,a.label))return a.value}return null},r.prototype.userNameLikeAttributeOperation=function(t,r,i){for(var s=e.getService(e.ServiceType.StringUtils),n=0,a=r.uniqueTextValues;n<a.length;n++){var o=a[n],u=r.textFieldsByValue[o].field;if(s.stringContains(u.attributes.name,"user")||s.stringContains(u.id,"user"))return o}return null},r.prototype.singleTextFieldOperation=function(e,t,r){if(1===t.uniqueTextValues.length){var i=t.uniqueTextValues[0];return 2===t.textFieldsByValue[i].count&&(e.createAccountForm=!0),i}return null},r.prototype.multipleTextFieldOperation=function(e,t,r){for(var i=0,s=t.uniqueTextValues;i<s.length;i++){var n=s[i];if(t.textFieldsByValue[n].count>1)return e.createAccountForm=!0,n}return null},r.prototype.nearPasswordFieldOpeartion=function(e,t,r){for(var i=e.fields,s=1;s<i.length;++s)if("password"===i[s].type){var n=i[s-1];if("password"!==n.type)return n.value}return null},r.prototype.existingUserNameOperation=function(e,t,r){for(var i in g_sites)if(t.uniqueTextValues.indexOf(g_sites[i].unencryptedUsername)>-1)return g_sites[i].unencryptedUsername;return null},r.prototype.uniqueEmailFieldOperation=function(e,t,i){for(var s=[],n=0,a=t.uniqueTextValues;n<a.length;n++){var o=a[n],u=o.match(r.emailRegex);u&&1===u.length&&s.push(o)}return 1===s.length?s[0]:null},r.emailRegex=/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*/g,r}(i.FieldParserAbstract),i.UserNameFieldParser=s}(LPModule||(LPModule={})),function(e){var t,r,i;t=e.Services||(e.Services={}),r=t.SiteParser||(t.SiteParser={}),i=function(){function e(){}return e.prototype.initialize=function(){},e.prototype.decrypt=function(e,t){return lpmdec_acct(t,!0,e,g_shares)},e.prototype.findMatchingSitePassword=function(e,t){Array.isArray(t)||(t=[t]);var r=t.indexOf(this.decrypt(e,e.password));if(-1===r&&e.fields&&e.fields.length>0)for(var i=0;i<e.fields.length;++i){var s=e.fields[i];if("password"===s.type&&(r=t.indexOf(this.decrypt(e,s.value)))>-1)break}return r>-1?t[r]:null},e.prototype.hasMatchingSiteUserName=function(e,t){if(!t)return!1;if(this.userNamesMatch(e.unencryptedUsername,t))return!0;if(e.fields&&e.fields.length)for(var r=0,i=e.fields;r<i.length;r++){var s=i[r];switch(s.type){case"text":case"email":case"tel":if(this.userNamesMatch(this.decrypt(e,s.value),t))return!0}}return!1},e.prototype.userNamesMatch=function(e,t){return e===t||this.userNameInEmail(e,t)||this.userNameInEmail(t,e)||this.isMaskedUsername(e,t)},e.prototype.userNameInEmail=function(e,t){if(t&&t.indexOf("@")>-1){var r=t.split("@");return 2===r.length&&e===r[0]}return!1},e.prototype.isMaskedUsername=function(e,t){return(t.indexOf("*")>-1||t.indexOf(String.fromCharCode(8226))>-1)&&e.length===t.length&&(e[0]===t[0]||e[e.length-1]===t[t.length-1])},e}(),r.SiteParserService=i,t.register(e.ServiceType.SiteParser,i)}(LPModule||(LPModule={}));
//# sourceMappingURL=sourcemaps/modules-background.js.map
