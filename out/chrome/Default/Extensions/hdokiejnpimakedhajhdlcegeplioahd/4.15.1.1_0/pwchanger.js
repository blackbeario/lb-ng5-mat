function PWCHANGER(){var n=2,t="",o=new Array,i="",a="",r="",s="",u="",c="",p=0,d=0,f="",y="",h=new Array,g=100100,k=10,_="",m=[];function v(){return"undefined"!=typeof $?$.ajax:LPPlatform.doAjax}function w(e,n,o,i,a,r,s){var u=void 0!==n&&null!=n&&""!=n?{wxusername:e,wxhash:n}:{};void 0!==s&&null!=s&&""!=s&&(u.vendor=s);var c=t+"getaccts.php?changepw=1&changepw2=1&includersaprivatekeyenc=1&changeun="+(e!=o?encodeURIComponent(o):"")+"&resetrsakeys="+(i?"1":"0")+"&includeendmarker=1";"undefined"!=typeof g_recovery_uid&&(c+="&recovery_uid="+encodeURIComponent(g_recovery_uid)),v()({url:c,type:"POST",data:u,timeout:3e5,success:"function"==typeof a?a:null,error:"function"==typeof r?r:null})}function b(e){0!==m.length?T(m,e,function(){"function"==typeof e&&e()}):"function"==typeof e&&e()}function T(e,n,o){var i=JSON.stringify({oneTimePasswords:e}),a=f||token;v()({url:t+"lmiapi/one-time-password",type:"POST",contentType:"application/json",headers:{"X-CSRF-TOKEN":a},data:i,dataType:"json",success:n,error:function(){"function"==typeof o&&o("POST new one time passwords failed")}})}function E(e){_?S(_,e,function(){"function"==typeof e&&e()}):"function"==typeof e&&e()}function S(e,n,o){var i=JSON.stringify({userData:e}),a=f||token;v()({url:t+"lmiapi/authenticator/backup",type:"POST",contentType:"application/json",headers:{"X-CSRF-TOKEN":a},data:i,dataType:"json",success:n,error:function(){"function"==typeof o&&o("POST new LP cloud backup failed")}})}function x(e){var n=h.callback;"function"==typeof n&&n(2,!1,!1,null)}function P(){try{if(2==n){o=h.reencrypt.split("\n"),"number"==typeof g_target_key_iterations&&(g=g_target_key_iterations,"undefined"!=typeof g_key_iterations&&g_key_iterations!=g_target_key_iterations&&(h.iterationschange="1")),u=h.newkey||make_lp_key_iterations(fix_username(h.newemail),h.newpassword,g),i+=o[0]+"\n";var e=o[1];if(""!=e){var y=rsa_extract_privatekey(e,h.oldkey);""==y&&""!=h.oldkey1&&(y=rsa_extract_privatekey(e,h.oldkey1)),""==y?a="":(a=rsa_encrypt_privatekey(y,u),y=null),r=SHA256(AES.bin2hex(u).toUpperCase()),s=SHA256(a)}}var w,b;if(void 0===o.length)return void h.callback(2,!1,!1,"F2 : internal error");for(var E=n+3;n<o.length&&n<E;++n){var A=o[n].replace(/\r\n|\r|\n/g,"").split("\t");if(l=A[0],"endmarker"!=l){var C=void 0!==A.length&&A.length>=2&&"0"==A[1];if(void 0!==l.length&&l.length){var j=null;try{w=dec(l,h.oldkey),b=enc(w,u)}catch(e){j=e}if(!AES.ok(b)||null==w||void 0===w.length||0==w.length||void 0===b.length||0==b.length||null!=j){var N=null;try{enc(" ",u)}catch(e){b="EXCEPTIONB",N=e}if(!C){if(null!=N){var R=void 0===u.length?"undefined":u.length;c+="encrypting <space> using m_newkey (m_newkey.length="+R+") resulted in EXCEPTION_B!\n"}c+="enc: "+l+" decrypted:  reencrypted to: "+b+(null==j?"":" : EXCEPTION_A!")+"\n",p++}}C||d++,i+=l+":"+b+"\n","function"==typeof h.status&&h.status(1,(n-1)/(o.length-2))}}else h.foundendmarker=!0}if(n<o.length)return void setTimeout(function(){P()},0);if(!h.foundendmarker)return void("function"==typeof h.callback&&h.callback(2,!1,!1,"D : Data download not complete"));if(void 0!==k&&k||(k=10),""!=c&&p>=d/100*k){var I={errors:c,username:h.oldemail};return v()({url:t+"debug.php",data:I,type:"POST",timeout:6e5,success:function(e){},error:function(e,n){}}),void("function"==typeof h.callback&&h.callback(3,null,null,"E : "+c))}K=h.oldkey,F=u,G=function(){var e,n,o,i,a;h.iterationschange?(e=h.oldkey,n=u,o=O,i=x,a=f||token,v()({url:t+"lmiapi/one-time-password",type:"GET",contentType:"application/json",dataType:"json",headers:{"X-CSRF-TOKEN":a},success:function(t){if("object"==typeof t.oneTimePasswords)if(m=[],0!==t.oneTimePasswords.length){var a=[];try{for(var r=fix_username(h.newemail),s=0;s<t.oneTimePasswords.length;s++){var u=t.oneTimePasswords[s],c={},l=dec(u.encryptedOneTimePassword,e),p=AES.hex2bin(l),d=make_lp_hash(r,p),f=make_lp_key(r,p);u.hash=d,u.randomEncryptedKey=enc(AES.bin2hex(e),f),c.encryptedOneTimePassword=enc(l,n),c.randomEncryptedKey=enc(AES.bin2hex(n),f),c.hash=d,a.push(c),m.push(u)}}catch(e){return void("function"==typeof i&&i("OTP Encryption failed"))}T(a,o,i)}else"function"==typeof o&&o();else"function"==typeof i&&i("Invalid one time password response")},error:function(e){"function"==typeof i&&i("GET one time passwords failed")}})):O()},X=x,D=f||token,v()({url:t+"lmiapi/authenticator/backup",type:"GET",contentType:"application/json",dataType:"json",headers:{"X-CSRF-TOKEN":D},success:function(e){var n;try{_=e.userData;var t=dec(e.userData,K);n=enc(t,F)}catch(e){return void("function"==typeof X&&X("Encryption failed"))}S(n,G,X)},error:function(e){e.status&&404==e.status?"function"==typeof G&&G():"function"==typeof X&&X("GET new LP cloud backup failed")}})}catch(e){h.callback(2,!1,!1,"F : "+e.message)}var K,F,G,X,D}function O(){var e=h.newpwhash||make_lp_hash_iterations(u,h.newpassword,g),l={reencrypt:i,newprivatekeyenc:a,newuserkeyhexhash:r,newprivatekeyenchexhash:s,newpasswordhash:e,pwupdate:"1",email:h.newemail,token:f,encrypted_username:encecb(h.newemail,u),origusername:h.oldemail,key_iterations:g};if(h.iterationschange&&(l.iterationschange=h.iterationschange),h.hashmigration&&(l.hashmigration=h.hashmigration,l.ks=!0),"undefined"!=typeof g_is_recovery&&g_is_recovery&&(l.is_recovery="1"),void 0!==h.oldpwhash&&null!=h.oldpwhash&&""!=h.oldpwhash&&(l.wxusername=h.oldemail,l.wxhash=h.oldpwhash),void 0!==h.ks&&h.ks&&(l.ks="true"),void 0!==y&&null!=y&&(l.password_hint=y),"undefined"!=typeof g_su_pubkeys&&null!=g_su_pubkeys&&void 0!==g_su_pubkeys.length&&g_su_pubkeys.length>0){for(var k=!1,_=0,m=0;m<g_su_pubkeys.length;m++){var w=new RSAKey;""!=g_su_pubkeys[m]&&(parse_public_key(w,g_su_pubkeys[m])&&(l["sukey"+_]=w.encrypt(AES.bin2hex(u)),l["suuid"+_]=g_su_uids[m],k=!0,_++))}if(l.sukeycnt=_,0==k&&"function"==typeof h.callback)return void h.callback(2,!1,!1,"G : Please tell your administrator that all users marked as Administrators must log into a browser extension once in order to properly setup account recovery.")}if("undefined"!=typeof g_lu_pubkeys&&null!=g_lu_pubkeys){for(_=0,m=1;m<g_lu_pubkeys.length;m++){w=new RSAKey;""!=g_lu_pubkeys[m]&&(parse_public_key(w,g_lu_pubkeys[m])&&(l["lukey"+_]=w.encrypt(AES.bin2hex(u)),l["luuid"+_]=g_lu_uids[m],_++))}l.lukeycnt=_}"undefined"!=typeof g_recovery_uid&&(l.recovery_uid=g_recovery_uid),"undefined"!=typeof g_changeiterations&&1==g_changeiterations&&(l.iterationschange="1");var T=h.callback,S=u,x=h.newemail,P=h.status;h=new Array,o=new Array,i="",n=2,u="",c="",p=0,d=0,"function"==typeof P&&P(2,0),v()({url:t+"settings.php",data:l,type:"POST",timeout:6e5,success:function(e,n){"function"==typeof P&&P(2,1),-1!=e.indexOf("pwchangeok")?"function"==typeof T&&T(0,S,x):e.indexOf("reusepass")>=0?E(function(){b(function(){T(2,!1,!1,"H : "+e.split("\n")[1])})}):0==e.indexOf("error\n")?E(function(){b(function(){T(2,!1,!1,e.split("\n")[1])})}):E(function(){b(function(){T(2,!1,!1,"I : An error occured")})})},error:function(e,n,t){E(function(){b(function(){"function"==typeof T&&T(2,!1,!1,"J : "+n+" suberror="+t)})})}})}this.hashMigration=function(e,n,o,i,a,r,s,u,c){if(t=r,f=s,g=u,k=0,"function"!=typeof c&&(c=function(){}),e!==i){var l,p,d,y=function(e,n,t,o){0===e?c(!0):c(!1,o)},_=function(t){if("string"==typeof t)if("usernametaken"!=t){var r={oldkey:e,oldkey1:"",oldpwhash:n,oldemail:o,newemail:o,newkey:i,newpwhash:a,callback:y,reencrypt:t,status:status,foundendmarker:!1,iterationschange:"1",hashmigration:"1"};h=r,setTimeout(function(){P()},0)}else c(!1,"Username taken or deleted during hash migration");else c(!1,"Invalid response")},m=function(){c(!1,"Error retrieving accounts data during hash migration")};window.g_su_pubkeys?w(o,n,o,!1,_,m):(l=function(){w(o,n,o,!1,_,m)},p=function(){c(!1,"Failed to get sharing keys during hash migration")},d=f||s,v()({url:t+"lmiapi/users/me/publicsharingkeys",type:"GET",contentType:"application/json",dataType:"json",headers:{"X-CSRF-TOKEN":d},success:function(e){window.g_su_pubkeys=e.map(function(e){return e.publicSharingKey}),window.g_su_uids=e.map(function(e){return e.userId}),l&&l()},error:function(e){x("Cannot GET sharing keys for hash migration"),p&&p()}}))}else c(!1,"Hash migration already happened? Maybe stale extension data")},this.changepw=function(n,o,i,a,r,s,u,c,l,p,d,g,_,m,v){var b=void 0!==_?_:"";void 0!==m&&m&&(k=m),void 0!==d&&null!=d||(d=""),"function"!=typeof u&&(u=function(){}),f=d,y=g,t=c,"function"==typeof l&&l(0,0);w(i,o,a,s,function(e){if("string"==typeof e)if("usernametaken"!=e){"function"==typeof l&&l(0,1);var t={oldkey:n,oldkey1:b,oldpwhash:o,oldemail:i,newemail:a,newpassword:r,callback:u,reencrypt:e,status:l,foundendmarker:!1};v&&(t.ks="true"),h=t,setTimeout(function(){P()},0)}else u(1,!1,!1,"B : Username Taken");else u(4,!1,!1,"A : Invalid Response")},function(n){u(2,!1,!1,"C : "+textstatus+" suberror="+e)},p)}}
//# sourceMappingURL=sourcemaps/pwchanger.js.map
