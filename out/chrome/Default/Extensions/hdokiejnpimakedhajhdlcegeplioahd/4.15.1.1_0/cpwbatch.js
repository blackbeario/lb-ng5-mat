var CPWbatch,g_batchpagealive=!0,g_batchpagealiveinterval=-1,g_cpw_batchstates={};CPWbatch||(CPWbatch=new CPWbatch_lib);var g_cpw_batch_aid=null,g_cpwfast=!1,g_cpw_aid_queue=[],g_cpw_status_update_lastmsg="",F_OK=1,F_FAIL=2,F_TIMEOUT=4,F_PENDING=8,F_ALL=F_OK|F_FAIL|F_TIMEOUT|F_PENDING,P_RESET=!0,F_STARTED="started",F_DONE="done",F_NONE=null;function close_cpw_tabs(){g_ischrome&&get_selected_tab(null,function(t){cpwbot_close_cpw_tab_handler(t)})}function cpwbot_close_cpw_tab_handler(t){var e=gettabid(t);if(null!==g_cpw_server_initiated_tabid&&null!==t&&(e==CPWbot_bg.originating_tabid||e==CPWbot_bg.destination_tabid))if(g_ischrome)chrome.tabs.update(g_cpw_server_initiated_tabid,{active:!0});else if(g_issafari){(_=g_CS_tabs[g_cpw_server_initiated_tabid])&&_.activate()}else if(g_isopera){var _;(_=g_CS_tabs[g_cpw_server_initiated_tabid])&&_.update({selected:!0})}else if(g_ismaxthon);else if(g_isfirefoxsdk){for(var a=0;a<g_tabs.length;a++)if(g_tabs[a].id==g_cpw_server_initiated_tabid){g_tabs[a].activate();break}}else g_isfirefox&&activate_tabid(g_cpw_server_initiated_tabid);if(CPWbot_bg){if(null!==CPWbot_bg.originating_tabid)if(g_ischrome)void 0!==chrome.tabs.remove&&chrome.tabs.remove(CPWbot_bg.originating_tabid,function(){});else if((g_issafari||g_isopera)&&null!==g_CS_tabs){var i=g_CS_tabs[CPWbot_bg.originating_tabid];i&&i.close()}else if(g_ismaxthon);else if(g_isfirefoxsdk){for(a=0;a<g_tabs.length;a++)if(g_tabs[a].id==CPWbot_bg.originating_tabid){g_tabs[a].close();break}}else g_isfirefox&&close_tabid(CPWbot_bg.originating_tabid);if(null!==CPWbot_bg.destination_tabid)if(CPWbatch&&CPWbatch.deregister_worker(CPWbot_bg.destination_tabid),g_ischrome)void 0!==chrome.tabs.remove&&chrome.tabs.remove(CPWbot_bg.destination_tabid,function(){chrome.runtime.lastError&&debug&&L(chrome.runtime.lastError)});else if((g_issafari||g_isopera)&&null!==g_CS_tabs){var s=g_CS_tabs[CPWbot_bg.destination_tabid];s&&s.close()}else if(g_ismaxthon);else if(g_isfirefoxsdk){for(a=0;a<g_tabs.length;a++)if(g_tabs[a].id==CPWbot_bg.destination_tabid){g_tabs[a].close();break}}else g_isfirefox&&close_tabid(CPWbot_bg.destination_tabid)}}function start_pwchange_from_server(t,e){if(debug&&L("running start_pwchange_from_server for aid="+e+" batchstate="+CPWbatch.cpw_get_batchjob_state()),!lploggedin)return!1;CPWbatch&&CPWbatch.cpw_get_batchjob_state()&&CPWbatch.update_last_batch_timestamp();cpwbot_preinit();return dopwchange(e,!0,null,!0)}function end_pwchange_from_server(t,e){var _=cpwbot_getpwchangestate();"FAIL"!=_&&"CAPTCHA"!=_&&"DONE"!=_&&"OK"!=_&&"TIMEOUT"!=_&&0!=_&&null!==_&&(CPWbatch&&CPWbatch.cpw_get_batchjob_state()?CPWbot_bg&&e==CPWbot_bg.getpwchangeaid()?(L("halting for aid="+e+" current_state="+_),cpwbot_halt()):pass:cpwbot_halt()),g_isfirefox?cpwbot_close_cpw_tab_handler(LP.mostRecent().getBrowser().selectedTab):get_selected_tab(null,function(t){cpwbot_close_cpw_tab_handler(t)})}function CPWbatch_lib(){var t=this;this.m_workers={},this.m_max_workers=1,this.m_workermap={};var e=0,_=null,a=null,i={};function s(){this.m_workers=[],t.cpw_batchjob_reset_stats(),a=null}function c(t){return"undefined"!=typeof g_sites?g_sites[t]:"undefined"!=typeof lpaccts?lpaccts[t]:null}this.register_worker=function(e,_){if(null===this.m_workers||null==e)return!1;var a=e.toString();return t.count_workers()>=this.m_max_workers?(L("too many workers, "+t.count_workers()+" >= "+this.m_max_workers),!1):(L("registered: worker "+a+" aid="+_),this.m_workers[a]=_,t.cpw_batchjob_mark_stats(F_PENDING),!0)},this.count_workers=function(){if(null===this.m_workers)return-1;var t,e=0;for(t in this.m_workers)this.m_workers.hasOwnProperty(t)&&e++;return e},this.deregister_worker=function(e){if(null===this.m_workers||null==e)return!1;var _=e.toString();return this.m_workers[_]&&(L("deregistered: worker "+_+" from aid="+this.m_workers[_]),delete this.m_workers[_]),t.cpw_batchjob_mark_stats(F_PENDING),!0},this.logout=function(){s(),e=0},this.init=function(){s()},this.cpw_batchjob_mark_stats=function(e,_){if(!i)return!1;var a=null,s=null;return _&&_.aid&&(s=_.aid),_&&_.reset&&(a=_.reset),0!=(e&F_ALL)&&((e&F_OK)==F_OK&&(void 0!==a&&a?i.ok=0:i.ok++),(e&F_FAIL)==F_FAIL&&(void 0!==a&&a?i.fail=0:i.fail++),(e&F_TIMEOUT)==F_TIMEOUT&&(void 0!==a&&a?i.timeout=0:i.timeout++),(e&F_PENDING)==F_PENDING&&(i.pending=void 0!==a&&a?0:t.count_workers()),void 0===i.byaid&&(i.byaid={}),s&&(void 0!==a&&a?delete i.byaid[s.toString()]:i.byaid[s.toString()]=e),!0)},this.cpw_batchjob_reset_stats=function(){if(i=null,!(i=new function(){}))return!1;if(t.cpw_batchjob_mark_stats(F_ALL,{reset:P_RESET}),"undefined"==typeof Date)return!1;var e=(new Date).getTime();return i.start_time=e,!0},this.cpw_batchjob_endjob_stats=function(){if(!i)return!1;var t=(new Date).getTime(),e=t-i.start_time;return i.end_time=t,i.elapsed=e,!0},this.cpw_batchjob_getstats=function(){return i},this.cpw_get_batchjob_state=function(){return a},this.cpw_set_batchjob_state=function(t){return void 0===t?(debug&&L("batchjob state is missing"),!1):(a=t,!0)},this.cpw_get_batchjob_queue_length=function(){return!g_cpw_aid_queue||g_cpw_aid_queue.length<0||void 0===g_cpw_aid_queue.length?-1:g_cpw_aid_queue.length},this.cpw_queue_change_donext=function(){var e=t.cpw_queue_change_getnext();if(g_cpw_batch_aid=e,null!=e){if(start_pwchange_from_server(g_cpw_server_initiated_tabid,e))return e;CPWbatch.cpw_batchjob_mark_stats(F_FAIL,{aid:e});var _="failed to initiate pw change in batch job for aid="+e;if(t.conditional_website_status_update({aid:e,msg:_}),console_error(_),lploggedin&&!c(e))return verbose_log("bad aid="+e+" proceed to next"),t.cpw_queue_change_donext();if(lploggedin&&c(e))return verbose_log("other error for aid="+e+" proceed to next"),t.cpw_queue_change_donext()}return setTimeout(function(){t.cpw_batch_end()},0),null},this.cpw_queue_change_getnext=function(){return!g_cpw_aid_queue||g_cpw_aid_queue.length<=0?null:g_cpw_aid_queue.shift()},this.cpw_batch_end=function(){CPWbatch&&(t.cpw_set_batchjob_state(F_DONE),g_cpwfast=!1,clearInterval(g_batchpagealiveinterval),g_cpw_batch_aid=null,CPWbatch&&(t.cpw_batchjob_endjob_stats(),t.cpw_batchjob_mark_stats(F_PENDING)),t.conditional_website_status_update({msg:"done"}),setTimeout(function(){g_cpw_aid_queue=[],g_cpw_batchstates={}},1e3))},this.cpw_queue_push=function(t){return void 0!==t&&null!==t&&(!isNaN(t)&&(g_cpw_aid_queue.push(t),!0))},this.cpw_batch_wait=function(_){if(CPWbatch){var a=!1,i=!1,s=g_cpw_batch_aid,c=cpwbot_getpwchangestate();switch(L(sprintf("cpw_batch_wait wake up, state=%s batchstate=%s aid=%d\n",c,CPWbatch.cpw_get_batchjob_state(),s)),CPWbatch.cpw_get_batchjob_state()==F_DONE&&(a=!0),c){case"TIMEOUT":case"CAPTCHA":case"FAIL":case"FAIL_PW_SAVED":a=!0,i=!0;break;case"OK":case"DONE":a=!0;break;case"DOCAPTCHA":!0;break;case"preinit":case null:CPWbot_bg.get_failstate()&&(a=!0,i=!0)}var r=(new Date).getTime();e>0&&r-e>3e5&&CPWbatch.cpw_get_batchjob_state()!=F_DONE&&(a||(a=!0,i=!0,c="TIMEOUT",L("BATCH JOB TIMED OUT"),CPWbatch.cpw_set_batchjob_state(F_DONE)));if(a){if(i?"TIMEOUT"==c?("TIMEOUT",CPWbatch.cpw_batchjob_mark_stats(F_TIMEOUT,{aid:s})):("FAIL",CPWbatch.cpw_batchjob_mark_stats(F_FAIL,{aid:s})):("OK",CPWbatch.cpw_batchjob_mark_stats(F_OK,{aid:s})),CPWbatch.cpw_batchjob_mark_stats(F_PENDING),CPWbatch.cpw_get_batchjob_state()==F_DONE)return;end_pwchange_from_server(g_cpw_server_initiated_tabid,s),t.conditional_website_status_update({aid:s,msg:"finished change on "+s+" in current batchjob"}),_()}else pass;setTimeout(function(){t.cpw_batch_wait(_)},1001)}},this.cpw_batch_begin=function(e){var _=e||!1;t.cpw_reset_status_update_ack(),g_cpw_status_update_lastmsg="",t.init();var a=!1;for(var i in g_cpw_aid_queue){var s=g_cpw_aid_queue[i];g_cpw_aid_queue.hasOwnProperty(i)&&(c(s)&&c(s).pwprotect&&(a=!0))}if(_||!a){g_batchpagealive=!0,g_batchpagealiveinterval=setInterval(function(){g_batchpagealive?(console.error("heartbeat received. setting to false"),g_batchpagealive=!1):(console.error("Killing the batch update. No heartbeat received."),g_cpw_aid_queue=[],cpwbot_halt())},3e4),t.cpw_batchjob_reset_stats(),t.cpw_set_batchjob_state(F_STARTED);var r=t.cpw_queue_change_donext();g_cpw_batch_aid=r,setTimeout(function(){t.cpw_batch_wait(t.cpw_queue_change_donext)},1001)}else security_prompt(function(){CPWbatch.cpw_batch_begin(!0)})},this.conditional_website_status_update=function(e){if(g_cpw_server_initiated_tabid){e||(e={});var a=e.tabid;void 0===a&&(a=null);var i=e.recipe;void 0===i&&(i=null);var s=e.msg;void 0===s&&(s="");var c=e.aid;void 0===c&&(c=CPWbot_bg.getpwchangeaid());var r=e.state;void 0===r&&(r=cpwbot_getpwchangestate());var n=e.batchstate;void 0===n&&(n=CPWbatch.cpw_get_batchjob_state());var o=r,b=c;void 0===g_cpw_batchstates[b]&&(g_cpw_batchstates[b]=[]),g_cpw_batchstates[b].push(o);var g,u=n;if(null!==u&&CPWbatch){CPWbatch.cpw_batchjob_mark_stats(F_PENDING);try{g=LPJSON.stringify(CPWbatch.cpw_batchjob_getstats())}catch(t){var d="JSON error: "+t;CPWbot_bg&&CPWbot_bg.warning_phone_home(d),console_error(d)}}else g=LPJSON.stringify(CPWbot_bg.get_timestamps());if(CPWbot_bg&&null===CPWbot_bg.originating_tabid&&null===CPWbot_bg.originating_tab&&null!==g_cpw_server_initiated_tabid&&null!==CPWbot_bg.destination_tabid&&null!==CPWbot_bg.destination_tab){var h="";if(g_isdebug&&(h=CPWbot_bg.get_user_debug_messages()),CPWbatch.cpw_get_batchjob_state()){if(!_){s!=g_cpw_status_update_lastmsg&&(s=g_cpw_status_update_lastmsg+"\n"+s),g_cpw_status_update_lastmsg=s}g_cpw_status_update_lastmsg=s,t.cpw_clear_status_update_ack();var p=JSON.stringify({aid:b,state:JSON.stringify(g_cpw_batchstates),msg:s,debugmsg:h});sendCS(g_cpw_server_initiated_tabid,{cmd:"cpw_batch_status_update",msgstr:p,batchstate:u,stats:g})}else sendCS(g_cpw_server_initiated_tabid,{cmd:"cpw_status_update",state:JSON.stringify(g_cpw_batchstates),msg:s,debugmsg:h,aid:b,batchstate:u,stats:g})}}},this.cpw_set_status_update_ack=function(t){_=t},this.cpw_get_status_update_ack=function(){return _},this.cpw_clear_status_update_ack=function(){t.cpw_set_status_update_ack(!1)},this.cpw_reset_status_update_ack=function(){_=null},this.update_last_batch_timestamp=function(){return e=(new Date).getTime()},this.get_last_batch_timestamp=function(){return e}}function iscpwfast(){if(void 0!==g_cpwfast&&!0===g_cpwfast)return!0}
//# sourceMappingURL=sourcemaps/cpwbatch.js.map
